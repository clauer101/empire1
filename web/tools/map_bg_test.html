<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map Background Test</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #1a1a2e;
      --surface: #16213e;
      --accent:  #4fc3f7;
      --accent2: #7ecfff;
      --text:    #e0e0e0;
      --muted:   #888;
      --border:  #2a2a4a;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: monospace;
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Toolbar â”€â”€ */
    #toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    #toolbar h1 {
      font-size: 1rem;
      color: var(--accent);
      letter-spacing: 2px;
      white-space: nowrap;
    }

    .ctrl {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .ctrl label { color: var(--muted); white-space: nowrap; }

    .ctrl select, .ctrl button {
      background: #2a2a4a;
      color: var(--text);
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 10px;
      font-family: monospace;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .ctrl select:focus, .ctrl button:hover { border-color: var(--accent); outline: none; }

    .ctrl input[type=range] { width: 100px; accent-color: var(--accent); }
    .ctrl .val { min-width: 3ch; color: var(--accent2); }

    .sep { width: 1px; background: var(--border); align-self: stretch; }

    /* â”€â”€ Canvas container â”€â”€ */
    #grid-wrap {
      position: relative;
      overflow: hidden;
    }

    #grid-canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* â”€â”€ Status bar â”€â”€ */
    #status {
      position: absolute;
      bottom: 8px;
      left: 12px;
      font-size: 0.7rem;
      color: var(--muted);
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="toolbar">
  <h1>ðŸ—º Map Background Test</h1>

  <div class="sep"></div>

  <div class="ctrl">
    <label>Karte:</label>
    <select id="map-select"><option value="">â€” keine â€”</option></select>
  </div>

  <div class="ctrl">
    <label>Map-Alpha:</label>
    <input type="range" id="map-alpha" min="0" max="100" value="100" />
    <span class="val" id="map-alpha-val">1.00</span>
  </div>

  <div class="ctrl">
    <label>Overlay-Alpha:</label>
    <input type="range" id="overlay-alpha" min="0" max="100" value="28" />
    <span class="val" id="overlay-alpha-val">0.28</span>
  </div>

  <div class="sep"></div>

  <div class="ctrl">
    <label>Hex-Size:</label>
    <input type="range" id="hex-size" min="16" max="80" value="36" />
    <span class="val" id="hex-size-val">36</span>
  </div>

  <div class="ctrl">
    <button id="btn-center">âŠ™ Zentrieren</button>
  </div>
</div>

<div id="grid-wrap">
  <canvas id="grid-canvas"></canvas>
  <div id="status">Kein Kartenbild geladen.</div>
</div>

<script type="module">
import { HexGrid, registerTileType } from '../js/lib/hex_grid.js';

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mapSelect      = document.getElementById('map-select');
const mapAlphaSlider = document.getElementById('map-alpha');
const mapAlphaVal    = document.getElementById('map-alpha-val');
const overlaySlider  = document.getElementById('overlay-alpha');
const overlayVal     = document.getElementById('overlay-alpha-val');
const hexSizeSlider  = document.getElementById('hex-size');
const hexSizeVal     = document.getElementById('hex-size-val');
const btnCenter      = document.getElementById('btn-center');
const statusEl       = document.getElementById('status');
const canvas         = document.getElementById('grid-canvas');

// â”€â”€ Build the default map tile layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mirrors python_server/config/maps/default.yaml
// Axial coordinates (q, r)

const PATH_TILES = [
  // north path
  [0,-5],[0,-4],[0,-3],[0,-2],[0,-1],
  // south path
  [0,5],[0,4],[0,3],[0,2],[0,1],
  // east path
  [5,0],[4,0],[3,0],[2,0],[1,0],
  // west path
  [-5,0],[-4,0],[-3,0],[-2,0],[-1,0],
];

const CASTLE_TILES = [[0, 0]];

const SPAWNPOINTS = [
  [0, -5], [0, 5], [5, 0], [-5, 0],
];

const BUILD_TILES = [
  [1,-4],[-1,-3],[1,-3],[-1,-2],[1,-2],[-1,-1],[1,-1],
  [4,-1],[3,-1],[4,1],[3,1],
  [-4,-1],[-3,-1],[-4,1],[-3,1],
  [-1,1],[1,1],[-1,2],[1,2],[-1,3],[1,3],[-1,4],[1,4],
];

// â”€â”€ Create HexGrid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let grid = null;

function buildGrid(hexSize) {
  if (grid) {
    grid.destroy();
    canvas.innerHTML = ''; // clear any leftover state
  }

  grid = new HexGrid({
    canvas,
    cols: 0,   // we'll set tiles manually
    rows: 0,
    hexSize,
  });

  // Clear auto-generated tiles and populate from map layout
  grid.tiles.clear();

  for (const [q, r] of BUILD_TILES)   grid.tiles.set(`${q},${r}`, { type: 'empty' });
  for (const [q, r] of PATH_TILES)    grid.tiles.set(`${q},${r}`, { type: 'path' });
  for (const [q, r] of CASTLE_TILES)  grid.tiles.set(`${q},${r}`, { type: 'castle' });
  for (const [q, r] of SPAWNPOINTS)   grid.tiles.set(`${q},${r}`, { type: 'spawnpoint' });

  grid.addVoidNeighbors();

  // Restore live settings
  grid.mapAlpha         = parseFloat(mapAlphaSlider.value) / 100;
  grid.tileOverlayAlpha = parseFloat(overlaySlider.value)  / 100;

  if (mapSelect.value) {
    grid.setMapBackground(mapSelect.value).then(() => {
      statusEl.textContent = `Kartenbild: ${mapSelect.options[mapSelect.selectedIndex].text}`;
    });
  }
}

buildGrid(parseInt(hexSizeSlider.value));

// â”€â”€ Fetch map list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadMapList() {
  try {
    const res  = await fetch('/api/maps');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    for (const { name, url } of (data.maps || [])) {
      const opt = document.createElement('option');
      opt.value = url;
      opt.textContent = name;
      mapSelect.appendChild(opt);
    }
    // Auto-select first map
    if (mapSelect.options.length > 1) {
      mapSelect.selectedIndex = 1;
      mapSelect.dispatchEvent(new Event('change'));
    }
  } catch (e) {
    statusEl.textContent = `Fehler beim Laden der Kartenliste: ${e.message}`;
  }
}

loadMapList();

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mapSelect.addEventListener('change', () => {
  const url = mapSelect.value;
  if (!url) {
    grid.setMapBackground(null);
    statusEl.textContent = 'Kein Kartenbild geladen.';
    return;
  }
  statusEl.textContent = 'Lade Kartenbildâ€¦';
  grid.setMapBackground(url)
    .then(() => {
      statusEl.textContent = `Kartenbild: ${mapSelect.options[mapSelect.selectedIndex].text}`;
    })
    .catch(e => {
      statusEl.textContent = `Fehler: ${e.message}`;
    });
});

mapAlphaSlider.addEventListener('input', () => {
  const v = parseFloat(mapAlphaSlider.value) / 100;
  mapAlphaVal.textContent = v.toFixed(2);
  if (grid) { grid.mapAlpha = v; grid._invalidateBase(); grid._dirty = true; }
});

overlaySlider.addEventListener('input', () => {
  const v = parseFloat(overlaySlider.value) / 100;
  overlayVal.textContent = v.toFixed(2);
  if (grid) { grid.tileOverlayAlpha = v; grid._invalidateBase(); grid._dirty = true; }
});

hexSizeSlider.addEventListener('change', () => {
  const v = parseInt(hexSizeSlider.value);
  hexSizeVal.textContent = v;
  buildGrid(v);
});

hexSizeSlider.addEventListener('input', () => {
  hexSizeVal.textContent = hexSizeSlider.value;
});

btnCenter.addEventListener('click', () => {
  if (grid) { grid._hasUserInteracted = false; grid._centerGrid(); grid._dirty = true; }
});
</script>
</body>
</html>
