INFO:     192.168.178.25:64626 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTY2NDc1NCwiZXhwIjoxNzcxNzUxMTU0fQ.4GrWL07aX-OGBdo6FIVnyg65J9EN1XGe0dXORrefe9I" [accepted]
08:55:38 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
08:55:38 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
08:55:38 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
08:56:05 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
08:56:05 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
09:02:30 [INFO] __main__: Shutdown signal received — stopping …
09:02:31 [INFO] __main__: Shutting down …
09:02:31 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:02:31 [INFO] websockets.server: server closing
09:02:31 [INFO] websockets.server: server closed
09:02:31 [INFO] gameserver.network.server: WebSocket server stopped
09:02:31 [INFO] __main__:   WebSocket server stopped
09:02:31 [INFO] __main__:   REST API server stopped
09:02:31 [INFO] __main__:   debug dashboard stopped
09:02:31 [INFO] __main__:   database closed
09:02:31 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:02:34 [INFO] __main__: === Game Server starting ===
09:02:34 [INFO] __main__: Loading configuration …
09:02:35 [INFO] __main__:   items:        235 loaded from config
09:02:35 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:02:35 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:02:35 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:02:35 [INFO] __main__:   game_config:  loaded
09:02:35 [INFO] __main__: Initializing persistence …
09:02:35 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:02:35 [INFO] __main__:   database:     connected (gameserver.db)
09:02:35 [INFO] gameserver.persistence.state_load: Restoring state from state.yaml (saved at 2026-02-22T09:02:31, version 1)
09:02:35 [INFO] gameserver.persistence.state_load: Restored 2 empires, 0 attacks, 0 battles
09:02:35 [INFO] __main__:   state:        restored from disk (2 empires, 0 attacks)
09:02:35 [INFO] __main__: Creating services …
09:02:35 [INFO] __main__:   upgrade_provider: 235 items registered
09:02:35 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:02:35 [INFO] __main__:   all services created
09:02:35 [INFO] __main__: Wiring event handlers …
09:02:35 [INFO] __main__:   event handlers registered
09:02:35 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:02:35 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:02:35 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:02:35 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:02:35 [INFO] __main__: Restored 2 empires from saved state
09:02:35 [INFO] __main__: Starting network servers …
09:02:35 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:02:35 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:02:35 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:02:35 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:02:37 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:02:37 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [18241]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:02:37 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:02:37 [INFO] __main__: Starting game loop …
09:02:37 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
09:02:51 [INFO] __main__: Shutdown signal received — stopping …
09:02:51 [INFO] __main__: Shutting down …
09:02:51 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:02:51 [INFO] websockets.server: server closing
09:02:51 [INFO] websockets.server: server closed
09:02:51 [INFO] gameserver.network.server: WebSocket server stopped
09:02:51 [INFO] __main__:   WebSocket server stopped
09:02:51 [INFO] __main__:   REST API server stopped
09:02:51 [INFO] __main__:   debug dashboard stopped
09:02:51 [INFO] __main__:   database closed
09:02:51 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:02:54 [INFO] __main__: === Game Server starting ===
09:02:54 [INFO] __main__: Loading configuration …
09:02:55 [INFO] __main__:   items:        235 loaded from config
09:02:55 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:02:55 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:02:55 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:02:55 [INFO] __main__:   game_config:  loaded
09:02:55 [INFO] __main__: Initializing persistence …
09:02:55 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:02:55 [INFO] __main__:   database:     connected (gameserver.db)
09:02:55 [INFO] gameserver.persistence.state_load: Restoring state from state.yaml (saved at 2026-02-22T09:02:51, version 1)
09:02:55 [INFO] gameserver.persistence.state_load: Restored 2 empires, 0 attacks, 0 battles
09:02:55 [INFO] __main__:   state:        restored from disk (2 empires, 0 attacks)
09:02:55 [INFO] __main__: Creating services …
09:02:55 [INFO] __main__:   upgrade_provider: 235 items registered
09:02:55 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:02:55 [INFO] __main__:   all services created
09:02:55 [INFO] __main__: Wiring event handlers …
09:02:55 [INFO] __main__:   event handlers registered
09:02:55 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:02:55 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:02:55 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:02:55 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:02:55 [INFO] __main__: Restored 2 empires from saved state
09:02:55 [INFO] __main__: Starting network servers …
09:02:55 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:02:55 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:02:55 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:02:55 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:02:56 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:02:56 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [18352]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:02:57 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:02:57 [INFO] __main__: Starting game loop …
09:02:57 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
09:03:28 [INFO] __main__: Shutdown signal received — stopping …
09:03:29 [INFO] __main__: Shutting down …
09:03:29 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:03:29 [INFO] websockets.server: server closing
09:03:29 [INFO] websockets.server: server closed
09:03:29 [INFO] gameserver.network.server: WebSocket server stopped
09:03:29 [INFO] __main__:   WebSocket server stopped
09:03:29 [INFO] __main__:   REST API server stopped
09:03:29 [INFO] __main__:   debug dashboard stopped
INFO:     Shutting down
09:03:29 [INFO] __main__:   database closed
09:03:29 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:03:31 [INFO] __main__: === Game Server starting ===
09:03:31 [INFO] __main__: Loading configuration …
09:03:32 [INFO] __main__:   items:        235 loaded from config
09:03:32 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:03:32 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:03:32 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:03:32 [INFO] __main__:   game_config:  loaded
09:03:32 [INFO] __main__: Initializing persistence …
09:03:32 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:03:32 [INFO] __main__:   database:     connected (gameserver.db)
09:03:32 [INFO] gameserver.persistence.state_load: Restoring state from state.yaml (saved at 2026-02-22T09:03:29, version 1)
09:03:32 [INFO] gameserver.persistence.state_load: Restored 2 empires, 0 attacks, 0 battles
09:03:32 [INFO] __main__:   state:        restored from disk (2 empires, 0 attacks)
09:03:32 [INFO] __main__: Creating services …
09:03:32 [INFO] __main__:   upgrade_provider: 235 items registered
09:03:32 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:03:32 [INFO] __main__:   all services created
09:03:32 [INFO] __main__: Wiring event handlers …
09:03:32 [INFO] __main__:   event handlers registered
09:03:32 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:03:32 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:03:32 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:03:32 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:03:32 [INFO] __main__: Restored 2 empires from saved state
09:03:32 [INFO] __main__: Starting network servers …
09:03:32 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:03:32 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:03:32 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:03:32 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:03:34 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:03:34 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [18485]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:03:34 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:03:34 [INFO] __main__: Starting game loop …
09:03:34 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
09:03:37 [INFO] __main__: Shutdown signal received — stopping …
09:03:38 [INFO] __main__: Shutting down …
09:03:38 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:03:38 [INFO] websockets.server: server closing
09:03:38 [INFO] websockets.server: server closed
09:03:38 [INFO] gameserver.network.server: WebSocket server stopped
09:03:38 [INFO] __main__:   WebSocket server stopped
09:03:38 [INFO] __main__:   REST API server stopped
09:03:38 [INFO] __main__:   debug dashboard stopped
09:03:38 [INFO] __main__:   database closed
09:03:38 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:03:40 [INFO] __main__: === Game Server starting ===
09:03:40 [INFO] __main__: Loading configuration …
09:03:41 [INFO] __main__:   items:        235 loaded from config
09:03:41 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:03:41 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:03:41 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:03:41 [INFO] __main__:   game_config:  loaded
09:03:41 [INFO] __main__: Initializing persistence …
09:03:41 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:03:41 [INFO] __main__:   database:     connected (gameserver.db)
09:03:41 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:03:41 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:03:41 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:03:41 [INFO] __main__: Creating services …
09:03:41 [INFO] __main__:   upgrade_provider: 235 items registered
09:03:41 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:03:41 [INFO] __main__:   all services created
09:03:41 [INFO] __main__: Wiring event handlers …
09:03:41 [INFO] __main__:   event handlers registered
09:03:41 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:03:41 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:03:41 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:03:41 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:03:41 [INFO] __main__: Restored 2 empires from saved state
09:03:41 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:03:41 [INFO] __main__: Starting network servers …
09:03:41 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:03:41 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:03:41 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:03:41 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:03:42 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:03:42 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [18571]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:03:42 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:03:42 [INFO] __main__: Starting game loop …
09:03:42 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:59526 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:03:47 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:03:47 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:03:47 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:03:47 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:03:52 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:03:52 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-33' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:05:11 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:05:12 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:05:12 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-140' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:05:12 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:05:12 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:05:12 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:05:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:05:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:05:16 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:05:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:05:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:05:20 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7748.9)
09:05:22 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:05:24 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
09:05:26 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:05:27 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:05:28 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:05:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:05:30 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:05:32 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:05:33 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:05:34 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7753.2)
09:05:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:05:36 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7754.6)
09:05:39 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7756.1)
09:05:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:05:41 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7757.8)
09:05:42 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7759.8)
09:05:43 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:05:43 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=12 (WARRIOR) killed — defender awarded 2.0 gold (total: 7762.0)
09:05:45 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:05:45 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=13 (WARRIOR) killed — defender awarded 2.0 gold (total: 7764.5)
09:05:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:05:47 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=14 (WARRIOR) killed — defender awarded 2.0 gold (total: 7767.0)
09:05:47 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:05:47 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:05:47 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:07:33 [INFO] __main__: Shutdown signal received — stopping …
09:07:33 [INFO] __main__: Shutting down …
09:07:33 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:07:33 [INFO] websockets.server: server closing
09:07:33 [INFO] websockets.server: server closed
09:07:33 [INFO] gameserver.network.server: WebSocket server stopped
09:07:33 [INFO] __main__:   WebSocket server stopped
09:07:33 [INFO] __main__:   REST API server stopped
09:07:33 [INFO] __main__:   debug dashboard stopped
09:07:33 [INFO] __main__:   database closed
09:07:33 [INFO] __main__:   goodbye
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:07:35 [INFO] __main__: === Game Server starting ===
09:07:35 [INFO] __main__: Loading configuration …
09:07:36 [INFO] __main__:   items:        235 loaded from config
09:07:36 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:07:36 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:07:36 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:07:36 [INFO] __main__:   game_config:  loaded
09:07:36 [INFO] __main__: Initializing persistence …
09:07:36 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:07:36 [INFO] __main__:   database:     connected (gameserver.db)
09:07:36 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:07:36 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:07:36 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:07:36 [INFO] __main__: Creating services …
09:07:36 [INFO] __main__:   upgrade_provider: 235 items registered
09:07:36 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:07:36 [INFO] __main__:   all services created
09:07:36 [INFO] __main__: Wiring event handlers …
09:07:36 [INFO] __main__:   event handlers registered
09:07:36 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:07:36 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:07:36 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:07:36 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:07:36 [INFO] __main__: Restored 2 empires from saved state
09:07:36 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:07:36 [INFO] __main__: Starting network servers …
09:07:36 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:07:36 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:07:36 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:07:36 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:07:37 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:07:37 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [18719]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:07:37 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:07:37 [INFO] __main__: Starting game loop …
09:07:37 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:53037 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:07:37 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:07:37 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:07:37 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:53044 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:07:41 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:07:41 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:07:41 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:07:41 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:07:47 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:07:47 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-33' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:07:48 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:53058 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:07:48 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:07:48 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:07:48 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:07:48 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:07:56 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:07:56 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:51140 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:07:57 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:07:57 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:07:57 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:07:57 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:08:00 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:08:00 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:51144 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:08:00 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:08:00 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:08:00 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:08:00 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:08:02 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:57394 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:08:03 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:08:03 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:08:03 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:08:03 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:08:08 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:08:08 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:57405 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:08:10 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:08:10 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:08:10 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:08:10 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:08:38 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:08:39 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:08:39 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-155' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:08:39 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:08:39 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:08:39 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:08:39 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:08:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:08:43 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:08:45 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:08:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:08:47 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7742.4)
09:08:49 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:08:51 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
09:08:53 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:08:54 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:08:55 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:08:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:08:57 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:08:59 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:08:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:09:01 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7746.7)
09:09:02 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:09:03 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7748.1)
09:09:05 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7749.6)
09:09:08 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:09:08 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7751.3)
09:09:09 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7753.3)
09:09:10 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:09:10 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=12 (WARRIOR) killed — defender awarded 2.0 gold (total: 7755.5)
09:09:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:09:12 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=13 (WARRIOR) killed — defender awarded 2.0 gold (total: 7758.0)
09:09:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:09:14 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=14 (WARRIOR) killed — defender awarded 2.0 gold (total: 7760.4)
09:09:14 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:09:14 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:09:14 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:14:00 [INFO] __main__: Shutdown signal received — stopping …
09:14:00 [INFO] __main__: Shutting down …
09:14:00 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:14:00 [INFO] websockets.server: server closing
09:14:00 [INFO] websockets.server: server closed
09:14:00 [INFO] gameserver.network.server: WebSocket server stopped
09:14:00 [INFO] __main__:   WebSocket server stopped
09:14:00 [INFO] __main__:   REST API server stopped
09:14:00 [INFO] __main__:   debug dashboard stopped
09:14:00 [INFO] __main__:   database closed
09:14:00 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:14:02 [INFO] __main__: === Game Server starting ===
09:14:02 [INFO] __main__: Loading configuration …
09:14:03 [INFO] __main__:   items:        235 loaded from config
09:14:03 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:14:03 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:14:03 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:14:03 [INFO] __main__:   game_config:  loaded
09:14:03 [INFO] __main__: Initializing persistence …
09:14:03 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:14:03 [INFO] __main__:   database:     connected (gameserver.db)
09:14:03 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:14:03 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:14:03 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:14:03 [INFO] __main__: Creating services …
09:14:03 [INFO] __main__:   upgrade_provider: 235 items registered
09:14:03 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:14:03 [INFO] __main__:   all services created
09:14:03 [INFO] __main__: Wiring event handlers …
09:14:03 [INFO] __main__:   event handlers registered
09:14:03 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:14:03 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:14:03 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:14:03 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:14:03 [INFO] __main__: Restored 2 empires from saved state
09:14:03 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:14:03 [INFO] __main__: Starting network servers …
09:14:03 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:14:03 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:14:03 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:14:03 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:14:05 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:14:05 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [19046]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:14:05 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:14:05 [INFO] __main__: Starting game loop …
09:14:05 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:62167 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:14:07 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:14:07 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:14:07 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:14:07 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:14:15 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:14:15 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-18' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:14:27 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:14:27 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:62187 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:14:31 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:14:31 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:14:31 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:14:31 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:14:32 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:14:33 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:14:33 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-59' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:14:33 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:14:33 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:14:33 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:14:33 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:14:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:14:37 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:14:39 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:14:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:14:41 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7734.5)
09:14:43 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:14:45 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
09:14:47 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:14:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:14:49 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:14:50 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:14:51 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:14:53 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:14:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:14:55 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7738.8)
09:14:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:14:57 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7740.2)
09:14:59 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7741.7)
09:15:02 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:15:02 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7743.4)
09:15:04 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:15:06 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:15:08 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:15:10 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7747.2)
09:15:14 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=12 (WARRIOR) reached goal, defender life: 5.0 -> 4.0 (damage: 1.0)
09:15:16 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=13 (WARRIOR) reached goal, defender life: 4.0 -> 3.0 (damage: 1.0)
09:15:18 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=14 (WARRIOR) reached goal, defender life: 3.0 -> 2.0 (damage: 1.0)
09:15:18 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:15:18 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:15:18 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:15:21 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
09:15:21 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
09:15:39 [INFO] __main__: Shutdown signal received — stopping …
09:15:40 [INFO] __main__: Shutting down …
09:15:40 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:15:40 [INFO] websockets.server: server closing
09:15:40 [INFO] websockets.server: server closed
09:15:40 [INFO] gameserver.network.server: WebSocket server stopped
09:15:40 [INFO] __main__:   WebSocket server stopped
09:15:40 [INFO] __main__:   REST API server stopped
09:15:40 [INFO] __main__:   debug dashboard stopped
09:15:40 [INFO] __main__:   database closed
09:15:40 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:15:42 [INFO] __main__: === Game Server starting ===
09:15:42 [INFO] __main__: Loading configuration …
09:15:43 [INFO] __main__:   items:        235 loaded from config
09:15:43 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:15:43 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:15:43 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:15:43 [INFO] __main__:   game_config:  loaded
09:15:43 [INFO] __main__: Initializing persistence …
09:15:43 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:15:43 [INFO] __main__:   database:     connected (gameserver.db)
09:15:43 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:15:43 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:15:43 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:15:43 [INFO] __main__: Creating services …
09:15:43 [INFO] __main__:   upgrade_provider: 235 items registered
09:15:43 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:15:43 [INFO] __main__:   all services created
09:15:43 [INFO] __main__: Wiring event handlers …
09:15:43 [INFO] __main__:   event handlers registered
09:15:43 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:15:43 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:15:43 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:15:43 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:15:43 [INFO] __main__: Restored 2 empires from saved state
09:15:43 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:15:43 [INFO] __main__: Starting network servers …
09:15:43 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:15:43 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:15:43 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:15:43 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:15:44 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:15:44 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [19201]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:15:44 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:15:44 [INFO] __main__: Starting game loop …
09:15:44 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:62228 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:15:50 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:15:50 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:15:50 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:15:50 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:15:54 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:15:54 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-20' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:15:57 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:15:57 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:15:57 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-25' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:15:57 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:15:57 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:15:57 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:15:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:15:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:16:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:16:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:16:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:16:05 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7731.0)
09:16:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:16:09 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
09:16:11 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:16:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:16:13 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:16:15 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:16:15 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:16:17 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:16:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:16:19 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7735.3)
09:16:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:16:21 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7736.7)
09:16:24 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7738.2)
09:16:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:16:27 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7739.9)
09:16:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:16:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:16:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:16:34 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7743.8)
09:16:38 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=12 (WARRIOR) reached goal, defender life: 5.0 -> 4.0 (damage: 1.0)
09:16:40 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=13 (WARRIOR) reached goal, defender life: 4.0 -> 3.0 (damage: 1.0)
09:16:42 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=14 (WARRIOR) reached goal, defender life: 3.0 -> 2.0 (damage: 1.0)
09:16:42 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:16:42 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:16:42 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:17:34 [INFO] __main__: Shutdown signal received — stopping …
09:17:34 [INFO] __main__: Shutting down …
09:17:34 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:17:34 [INFO] websockets.server: server closing
09:17:34 [INFO] websockets.server: server closed
09:17:34 [INFO] gameserver.network.server: WebSocket server stopped
09:17:34 [INFO] __main__:   WebSocket server stopped
09:17:34 [INFO] __main__:   REST API server stopped
09:17:34 [INFO] __main__:   debug dashboard stopped
09:17:34 [INFO] __main__:   database closed
09:17:34 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
09:17:36 [INFO] __main__: === Game Server starting ===
09:17:36 [INFO] __main__: Loading configuration …
09:17:37 [INFO] __main__:   items:        235 loaded from config
09:17:37 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:17:37 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:17:37 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:17:37 [INFO] __main__:   game_config:  loaded
09:17:37 [INFO] __main__: Initializing persistence …
09:17:37 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:17:37 [INFO] __main__:   database:     connected (gameserver.db)
09:17:37 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:17:37 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:17:37 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:17:37 [INFO] __main__: Creating services …
09:17:37 [INFO] __main__:   upgrade_provider: 235 items registered
09:17:37 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:17:37 [INFO] __main__:   all services created
09:17:37 [INFO] __main__: Wiring event handlers …
09:17:37 [INFO] __main__:   event handlers registered
09:17:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:17:37 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:17:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:17:37 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:17:37 [INFO] __main__: Restored 2 empires from saved state
09:17:37 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:17:37 [INFO] __main__: Starting network servers …
09:17:37 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:17:37 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:17:37 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:17:37 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:17:38 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:17:38 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [19359]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:17:39 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:17:39 [INFO] __main__: Starting game loop …
09:17:39 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:55748 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:17:41 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:17:41 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:17:41 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:17:41 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:17:46 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:17:46 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:55761 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:17:48 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:17:48 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:17:48 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:17:48 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:17:49 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:17:49 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-33' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:17:50 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:17:50 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:17:50 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-37' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:17:50 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:17:50 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:17:50 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:17:50 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:17:52 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:17:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:17:55 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:17:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:17:58 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.6)
09:17:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:18:02 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
09:18:03 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:18:04 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:18:05 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:18:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:18:07 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:18:09 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:18:10 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:18:12 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7734.8)
09:18:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:18:14 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7736.3)
09:18:16 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7737.7)
09:18:19 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:18:19 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7739.4)
09:18:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:18:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:18:24 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:18:27 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7743.3)
09:18:31 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=12 (WARRIOR) reached goal, defender life: 5.0 -> 4.0 (damage: 1.0)
09:18:33 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=13 (WARRIOR) reached goal, defender life: 4.0 -> 3.0 (damage: 1.0)
09:18:34 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=14 (WARRIOR) reached goal, defender life: 3.0 -> 2.0 (damage: 1.0)
09:18:34 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:18:34 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:18:34 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:26:33 [INFO] __main__: Shutdown signal received — stopping …
09:26:34 [INFO] __main__: Shutting down …
09:26:34 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
09:26:34 [INFO] websockets.server: server closing
09:26:34 [INFO] websockets.server: server closed
09:26:34 [INFO] gameserver.network.server: WebSocket server stopped
09:26:34 [INFO] __main__:   WebSocket server stopped
09:26:34 [INFO] __main__:   REST API server stopped
09:26:34 [INFO] __main__:   debug dashboard stopped
09:26:34 [INFO] __main__:   database closed
09:26:34 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
09:26:36 [INFO] __main__: === Game Server starting ===
09:26:36 [INFO] __main__: Loading configuration …
09:26:37 [INFO] __main__:   items:        235 loaded from config
09:26:37 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:26:37 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:26:37 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:26:37 [INFO] __main__:   game_config:  loaded
09:26:37 [INFO] __main__: Initializing persistence …
09:26:37 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:26:37 [INFO] __main__:   database:     connected (gameserver.db)
09:26:37 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:26:37 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:26:37 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:26:37 [INFO] __main__: Creating services …
09:26:37 [INFO] __main__:   upgrade_provider: 235 items registered
09:26:37 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:26:37 [INFO] __main__:   all services created
09:26:37 [INFO] __main__: Wiring event handlers …
09:26:37 [INFO] __main__:   event handlers registered
09:26:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:26:37 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:26:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:26:37 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:26:37 [INFO] __main__: Restored 2 empires from saved state
09:26:37 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:26:37 [INFO] __main__: Starting network servers …
09:26:37 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:26:37 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:26:37 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:26:37 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:26:38 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:26:38 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [19906]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:26:39 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:26:39 [INFO] __main__: Starting game loop …
09:26:39 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:65398 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:26:40 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:26:40 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:26:40 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:26:40 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:26:49 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:26:49 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-23' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:26:51 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:26:52 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:26:52 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-28' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:26:52 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:26:52 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:26:52 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:26:52 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:26:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:26:55 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:26:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:26:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:27:00 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7731.0)
09:27:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:27:03 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:27:05 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:27:06 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:27:07 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:27:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:27:09 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
09:27:11 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 5.0 -> 4.0 (damage: 1.0)
09:27:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:27:14 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7735.3)
09:27:15 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:27:16 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7736.7)
09:27:18 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7738.2)
09:27:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:27:21 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7739.9)
09:27:22 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:27:24 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:27:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:27:29 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7743.5)
09:27:29 [INFO] __main__: Shutdown signal received — stopping …
09:27:30 [INFO] __main__: Shutting down …
09:27:30 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
09:27:30 [INFO] websockets.server: server closing
09:27:30 [INFO] websockets.server: server closed
09:27:30 [INFO] gameserver.network.server: WebSocket server stopped
09:27:30 [INFO] __main__:   WebSocket server stopped
09:27:30 [INFO] __main__:   REST API server stopped
09:27:30 [INFO] __main__:   debug dashboard stopped
09:27:30 [INFO] __main__:   database closed
09:27:30 [INFO] __main__:   goodbye
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

09:27:32 [INFO] __main__: === Game Server starting ===
09:27:32 [INFO] __main__: Loading configuration …
09:27:33 [INFO] __main__:   items:        235 loaded from config
09:27:33 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:27:33 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:27:33 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:27:33 [INFO] __main__:   game_config:  loaded
09:27:33 [INFO] __main__: Initializing persistence …
09:27:33 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:27:33 [INFO] __main__:   database:     connected (gameserver.db)
09:27:33 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:27:33 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:27:33 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:27:33 [INFO] __main__: Creating services …
09:27:33 [INFO] __main__:   upgrade_provider: 235 items registered
09:27:33 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:27:33 [INFO] __main__:   all services created
09:27:33 [INFO] __main__: Wiring event handlers …
09:27:33 [INFO] __main__:   event handlers registered
09:27:33 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:27:33 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:27:33 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:27:33 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:27:33 [INFO] __main__: Restored 2 empires from saved state
09:27:33 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:27:33 [INFO] __main__: Starting network servers …
09:27:33 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:27:33 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:27:33 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:27:33 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:27:34 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:27:34 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [20001]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:27:34 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:27:34 [INFO] __main__: Starting game loop …
09:27:34 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:60835 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:27:36 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:27:36 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:27:36 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:27:36 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:27:44 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:27:44 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-20' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:28:19 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:60866 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:28:19 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:28:19 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:28:19 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:28:19 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:28:21 [INFO] __main__: Shutdown signal received — stopping …
09:28:22 [INFO] __main__: Shutting down …
09:28:22 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
09:28:22 [INFO] websockets.server: server closing
09:28:22 [INFO] websockets.server: server closed
09:28:22 [INFO] gameserver.network.server: WebSocket server stopped
09:28:22 [INFO] __main__:   WebSocket server stopped
09:28:22 [INFO] __main__:   REST API server stopped
09:28:22 [INFO] __main__:   debug dashboard stopped
09:28:22 [INFO] __main__:   database closed
09:28:22 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
09:28:24 [INFO] __main__: === Game Server starting ===
09:28:24 [INFO] __main__: Loading configuration …
09:28:25 [INFO] __main__:   items:        235 loaded from config
09:28:25 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
09:28:25 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
09:28:25 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
09:28:25 [INFO] __main__:   game_config:  loaded
09:28:25 [INFO] __main__: Initializing persistence …
09:28:25 [INFO] gameserver.persistence.database: Database connected: gameserver.db
09:28:25 [INFO] __main__:   database:     connected (gameserver.db)
09:28:25 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
09:28:25 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
09:28:25 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
09:28:25 [INFO] __main__: Creating services …
09:28:25 [INFO] __main__:   upgrade_provider: 235 items registered
09:28:25 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
09:28:25 [INFO] __main__:   all services created
09:28:25 [INFO] __main__: Wiring event handlers …
09:28:25 [INFO] __main__:   event handlers registered
09:28:25 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
09:28:25 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0}
09:28:25 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
09:28:25 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
09:28:25 [INFO] __main__: Restored 2 empires from saved state
09:28:25 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
09:28:25 [INFO] __main__: Starting network servers …
09:28:25 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
09:28:25 [INFO] websockets.server: server listening on 0.0.0.0:8765
09:28:25 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
09:28:25 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
09:28:26 [INFO] gameserver.network.rest_api: REST API created with 28 routes
09:28:26 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [20094]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
09:28:26 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
09:28:26 [INFO] __main__: Starting game loop …
09:28:26 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:60883 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:28:29 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:28:29 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:28:29 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
09:28:29 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:28:33 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:28:33 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
09:28:36 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
09:28:36 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-26' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
INFO:     192.168.178.2:49845 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:28:39 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:28:39 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:28:39 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:28:39 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:28:50 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:49864 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:28:50 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:28:50 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:28:50 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:28:50 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:28:54 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
09:28:54 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:49866 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
09:28:55 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
09:28:55 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
09:28:55 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
09:28:55 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
09:28:59 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
09:28:59 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
09:28:59 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-97' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1792> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1817, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
09:28:59 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
09:28:59 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
09:28:59 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
09:28:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
09:29:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
09:29:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
09:29:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
09:29:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
09:29:07 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7735.7)
09:29:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
09:29:11 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
09:29:13 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
09:29:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
09:29:15 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
09:29:17 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
09:29:17 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 6.1 -> 5.1 (damage: 1.0)
09:29:19 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 5.1 -> 4.1 (damage: 1.0)
09:29:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
09:29:21 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7739.9)
09:29:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
09:29:23 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7741.4)
09:29:26 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7742.9)
09:29:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
09:29:29 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7744.5)
09:29:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
09:29:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
09:29:34 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
09:29:36 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7748.2)
09:29:40 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=12 (WARRIOR) reached goal, defender life: 4.1 -> 3.1 (damage: 1.0)
09:29:42 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=13 (WARRIOR) reached goal, defender life: 3.1 -> 2.1 (damage: 1.0)
09:29:44 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=14 (WARRIOR) reached goal, defender life: 2.1 -> 1.1 (damage: 1.0)
09:29:44 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
09:29:44 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
09:29:44 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
09:31:05 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
09:31:05 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
12:53:55 [INFO] __main__: Shutdown signal received — stopping …
12:53:56 [INFO] __main__: Shutting down …
12:53:56 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
12:53:56 [INFO] websockets.server: server closing
12:53:56 [INFO] websockets.server: server closed
12:53:56 [INFO] gameserver.network.server: WebSocket server stopped
12:53:56 [INFO] __main__:   WebSocket server stopped
12:53:56 [INFO] __main__:   REST API server stopped
12:53:56 [INFO] __main__:   debug dashboard stopped
12:53:56 [INFO] __main__:   database closed
12:53:56 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

12:53:58 [INFO] __main__: === Game Server starting ===
12:53:58 [INFO] __main__: Loading configuration …
12:53:59 [INFO] __main__:   items:        235 loaded from config
12:53:59 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
12:53:59 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
12:53:59 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
12:53:59 [INFO] __main__:   game_config:  loaded
12:53:59 [INFO] __main__: Initializing persistence …
12:53:59 [INFO] gameserver.persistence.database: Database connected: gameserver.db
12:53:59 [INFO] __main__:   database:     connected (gameserver.db)
12:53:59 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
12:53:59 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
12:53:59 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
12:53:59 [INFO] __main__: Creating services …
12:53:59 [INFO] __main__:   upgrade_provider: 235 items registered
12:53:59 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
12:53:59 [INFO] __main__:   all services created
12:53:59 [INFO] __main__: Wiring event handlers …
12:53:59 [INFO] __main__:   event handlers registered
12:53:59 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
12:53:59 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
12:53:59 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
12:53:59 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
12:53:59 [INFO] __main__: Restored 2 empires from saved state
12:53:59 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
12:53:59 [INFO] __main__: Starting network servers …
12:53:59 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
12:53:59 [INFO] websockets.server: server listening on 0.0.0.0:8765
12:53:59 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
12:53:59 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
12:54:01 [INFO] gameserver.network.rest_api: REST API created with 28 routes
12:54:01 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [24210]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
12:54:01 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
12:54:01 [INFO] __main__: Starting game loop …
12:54:01 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:64415 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
12:54:02 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
12:54:02 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
12:54:02 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
12:54:02 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
12:54:11 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
12:54:11 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-29' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1885> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1910, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
12:54:25 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
12:54:26 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
12:54:26 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-51' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1885> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1910, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
12:54:26 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
12:54:26 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
12:54:26 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
12:54:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
12:54:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
12:54:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
12:54:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
12:54:34 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
12:54:34 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7733.8)
12:54:36 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
12:54:38 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
12:54:38 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
12:54:38 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
12:54:38 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: HERBOLOGY (5.8% of effort 800 = 46.5 culture)
12:54:38 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 330.6 (3.8%)
12:54:38 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
12:55:16 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
12:55:16 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
13:18:17 [INFO] __main__: Shutdown signal received — stopping …
13:18:18 [INFO] __main__: Shutting down …
13:18:18 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:18:18 [INFO] websockets.server: server closing
13:18:18 [INFO] websockets.server: server closed
13:18:18 [INFO] gameserver.network.server: WebSocket server stopped
13:18:18 [INFO] __main__:   WebSocket server stopped
13:18:18 [INFO] __main__:   REST API server stopped
13:18:18 [INFO] __main__:   debug dashboard stopped
13:18:18 [INFO] __main__:   database closed
13:18:18 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:18:19 [INFO] __main__: === Game Server starting ===
13:18:19 [INFO] __main__: Loading configuration …
13:18:20 [INFO] __main__:   items:        235 loaded from config
13:18:20 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:18:20 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:18:20 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
13:18:20 [INFO] __main__:   game_config:  loaded
13:18:20 [INFO] __main__: Initializing persistence …
13:18:20 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:18:20 [INFO] __main__:   database:     connected (gameserver.db)
13:18:20 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:18:20 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:18:20 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:18:20 [INFO] __main__: Creating services …
13:18:20 [INFO] __main__:   upgrade_provider: 235 items registered
13:18:20 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:18:20 [INFO] __main__:   all services created
13:18:20 [INFO] __main__: Wiring event handlers …
13:18:20 [INFO] __main__:   event handlers registered
13:18:20 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:18:20 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:18:20 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:18:20 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:18:20 [INFO] __main__: Restored 2 empires from saved state
13:18:20 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:18:20 [INFO] __main__: Starting network servers …
13:18:20 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:18:20 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:18:20 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:18:20 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:18:21 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:18:21 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25030]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:18:21 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:18:21 [INFO] __main__: Starting game loop …
13:18:21 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:55202 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:18:29 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:18:29 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:18:29 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:18:29 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:18:31 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:18:31 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-23' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1882> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1907, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:18:33 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:18:33 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:18:33 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-28' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1882> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1907, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:18:33 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:18:33 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:18:33 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:18:33 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:18:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:18:37 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:18:39 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:18:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:18:41 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.8)
13:18:43 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:18:45 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:18:45 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:18:45 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:18:45 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: MYSTIC (11.9% of effort 100 = 11.9 culture)
13:18:45 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 125.3 (1.4%)
13:18:45 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:19:31 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:55238 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:19:32 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:19:32 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:19:32 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
13:19:34 [INFO] __main__: Shutdown signal received — stopping …
13:19:34 [INFO] __main__: Shutting down …
13:19:34 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:19:34 [INFO] websockets.server: server closing
13:19:34 [INFO] websockets.server: server closed
13:19:34 [INFO] gameserver.network.server: WebSocket server stopped
13:19:34 [INFO] __main__:   WebSocket server stopped
13:19:34 [INFO] __main__:   REST API server stopped
13:19:34 [INFO] __main__:   debug dashboard stopped
13:19:34 [INFO] __main__:   database closed
13:19:34 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:19:36 [INFO] __main__: === Game Server starting ===
13:19:36 [INFO] __main__: Loading configuration …
13:19:37 [INFO] __main__:   items:        235 loaded from config
13:19:37 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:19:37 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:19:37 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
13:19:37 [INFO] __main__:   game_config:  loaded
13:19:37 [INFO] __main__: Initializing persistence …
13:19:37 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:19:37 [INFO] __main__:   database:     connected (gameserver.db)
13:19:37 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:19:37 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:19:37 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:19:37 [INFO] __main__: Creating services …
13:19:37 [INFO] __main__:   upgrade_provider: 235 items registered
13:19:37 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:19:37 [INFO] __main__:   all services created
13:19:37 [INFO] __main__: Wiring event handlers …
13:19:37 [INFO] __main__:   event handlers registered
13:19:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:19:37 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:19:37 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:19:37 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:19:37 [INFO] __main__: Restored 2 empires from saved state
13:19:37 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:19:37 [INFO] __main__: Starting network servers …
13:19:37 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:19:37 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:19:37 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:19:37 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:19:39 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:19:39 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25124]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:19:39 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:19:39 [INFO] __main__: Starting game loop …
13:19:39 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:55250 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:19:39 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:19:39 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:19:39 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:19:39 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:19:48 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
13:19:48 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:55259 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:19:48 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:19:48 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:19:48 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:19:48 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:19:49 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:19:49 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-33' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1882> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1907, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:19:50 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:19:50 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:19:50 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-37' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1882> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1907, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:19:50 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:19:50 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:19:50 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:19:50 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:19:52 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:19:54 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:19:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:19:58 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:19:58 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.6)
13:20:00 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:20:02 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:20:02 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:20:02 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:20:02 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: CRAFTSMANSHIP (6.1% of effort 200 = 12.2 culture)
13:20:02 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 238.3 (2.8%)
13:20:02 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:20:12 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
13:20:12 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
13:23:20 [INFO] __main__: Shutdown signal received — stopping …
13:23:20 [INFO] __main__: Shutting down …
13:23:20 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:23:20 [INFO] websockets.server: server closing
13:23:20 [INFO] websockets.server: server closed
13:23:20 [INFO] gameserver.network.server: WebSocket server stopped
13:23:20 [INFO] __main__:   WebSocket server stopped
13:23:20 [INFO] __main__:   REST API server stopped
13:23:20 [INFO] __main__:   debug dashboard stopped
13:23:20 [INFO] __main__:   database closed
13:23:20 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:23:22 [INFO] __main__: === Game Server starting ===
13:23:22 [INFO] __main__: Loading configuration …
13:23:23 [INFO] __main__:   items:        235 loaded from config
13:23:23 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:23:23 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:23:23 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
13:23:23 [INFO] __main__:   game_config:  loaded
13:23:23 [INFO] __main__: Initializing persistence …
13:23:23 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:23:23 [INFO] __main__:   database:     connected (gameserver.db)
13:23:23 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:23:23 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:23:23 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:23:23 [INFO] __main__: Creating services …
13:23:23 [INFO] __main__:   upgrade_provider: 235 items registered
13:23:23 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:23:23 [INFO] __main__:   all services created
13:23:23 [INFO] __main__: Wiring event handlers …
13:23:23 [INFO] __main__:   event handlers registered
13:23:23 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:23:23 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:23:23 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:23:23 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:23:23 [INFO] __main__: Restored 2 empires from saved state
13:23:23 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:23:23 [INFO] __main__: Starting network servers …
13:23:23 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:23:23 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:23:23 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:23:23 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:23:24 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:23:24 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25382]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:23:24 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:23:24 [INFO] __main__: Starting game loop …
13:23:24 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:63174 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:23:26 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:23:26 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:23:26 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:23:26 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:23:34 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:23:34 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-24' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1878> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1903, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:23:36 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:23:36 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:23:36 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-28' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1878> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1903, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:23:36 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:23:36 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:23:36 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:23:36 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:23:38 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:23:40 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:23:42 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:23:44 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:23:44 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.8)
13:23:46 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:23:48 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:23:48 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:23:48 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:23:48 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: MUSIC (13.5% of effort 4000 = 541.4 culture)
13:23:48 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 157.8 (1.8%)
13:23:48 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:23:57 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
13:23:57 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
13:24:40 [INFO] __main__: Shutdown signal received — stopping …
13:24:40 [INFO] __main__: Shutting down …
13:24:40 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:24:40 [INFO] websockets.server: server closing
13:24:40 [INFO] websockets.server: server closed
13:24:40 [INFO] gameserver.network.server: WebSocket server stopped
13:24:40 [INFO] __main__:   WebSocket server stopped
13:24:40 [INFO] __main__:   REST API server stopped
13:24:40 [INFO] __main__:   debug dashboard stopped
13:24:40 [INFO] __main__:   database closed
13:24:40 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:24:42 [INFO] __main__: === Game Server starting ===
13:24:42 [INFO] __main__: Loading configuration …
13:24:43 [INFO] __main__:   items:        235 loaded from config
13:24:43 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:24:43 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:24:43 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (35 keys)
13:24:43 [INFO] __main__:   game_config:  loaded
13:24:43 [INFO] __main__: Initializing persistence …
13:24:43 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:24:43 [INFO] __main__:   database:     connected (gameserver.db)
13:24:43 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:24:43 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:24:43 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:24:43 [INFO] __main__: Creating services …
13:24:43 [INFO] __main__:   upgrade_provider: 235 items registered
13:24:43 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:24:43 [INFO] __main__:   all services created
13:24:43 [INFO] __main__: Wiring event handlers …
13:24:43 [INFO] __main__:   event handlers registered
13:24:43 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:24:43 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:24:43 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:24:43 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:24:43 [INFO] __main__: Restored 2 empires from saved state
13:24:43 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:24:43 [INFO] __main__: Starting network servers …
13:24:43 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:24:43 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:24:43 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:24:43 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:24:44 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:24:44 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25479]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:24:45 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:24:45 [INFO] __main__: Starting game loop …
13:24:45 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:63241 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:24:45 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:24:45 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:24:45 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:24:45 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:24:55 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:24:55 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-32' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1878> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1903, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:24:55 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:24:56 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:24:56 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-36' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1878> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1903, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:24:56 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:24:56 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:24:56 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:24:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:24:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:24:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:25:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:25:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:25:04 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.6)
13:25:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:25:07 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:25:07 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:25:07 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:25:07 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: COPPER_BRONZE (4.1% of effort 2500 = 101.3 culture)
13:25:07 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 118.4 (1.4%)
13:25:07 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:32:35 [INFO] __main__: Shutdown signal received — stopping …
13:32:35 [INFO] __main__: Shutting down …
13:32:35 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:32:35 [INFO] websockets.server: server closing
13:32:35 [INFO] websockets.server: server closed
13:32:35 [INFO] gameserver.network.server: WebSocket server stopped
13:32:35 [INFO] __main__:   WebSocket server stopped
13:32:35 [INFO] __main__:   REST API server stopped
13:32:35 [INFO] __main__:   debug dashboard stopped
INFO:     Shutting down
13:32:35 [INFO] __main__:   database closed
13:32:35 [INFO] __main__:   goodbye
13:32:35 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:32:37 [INFO] __main__: === Game Server starting ===
13:32:37 [INFO] __main__: Loading configuration …
13:32:38 [INFO] __main__:   items:        235 loaded from config
13:32:38 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:32:38 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:32:38 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
13:32:38 [INFO] __main__:   game_config:  loaded
13:32:38 [INFO] __main__: Initializing persistence …
13:32:38 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:32:38 [INFO] __main__:   database:     connected (gameserver.db)
13:32:38 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:32:38 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:32:38 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:32:38 [INFO] __main__: Creating services …
13:32:38 [INFO] __main__:   upgrade_provider: 235 items registered
13:32:38 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:32:38 [INFO] __main__:   all services created
13:32:38 [INFO] __main__: Wiring event handlers …
13:32:38 [INFO] __main__:   event handlers registered
13:32:38 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:32:38 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:32:38 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:32:38 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:32:38 [INFO] __main__: Restored 2 empires from saved state
13:32:38 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:32:38 [INFO] __main__: Starting network servers …
13:32:38 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:32:38 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:32:38 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:32:38 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:32:39 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:32:39 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25750]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:32:39 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:32:39 [INFO] __main__: Starting game loop …
13:32:39 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:60505 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:32:39 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:32:39 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:32:39 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:60519 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:32:42 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:32:42 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:32:42 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:32:42 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:32:49 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:32:49 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-33' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:32:50 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:32:51 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:32:51 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-39' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:32:51 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:32:51 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:32:51 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:32:51 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:32:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:32:55 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:32:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:32:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:32:59 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7730.8)
13:33:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:33:03 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:33:03 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:33:03 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:33:03 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: RELIGION (12.7% of effort 3500 = 443.6 culture)
13:33:03 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 221.3 (2.6%)
13:33:03 [ERROR] gameserver.network.handlers: Battle loop crashed: Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1778, in _run_battle_task
    loot = _compute_and_apply_loot(battle, svc)
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1871, in _compute_and_apply_loot
    from gameserver.util.effects import RESTORE_LIFE_AFTER_LOSS_OFFSET
ImportError: cannot import name 'RESTORE_LIFE_AFTER_LOSS_OFFSET' from 'gameserver.util.effects' (/home/pi/e3/python_server/src/gameserver/util/effects.py)

13:33:37 [INFO] __main__: Shutdown signal received — stopping …
13:33:37 [INFO] __main__: Shutting down …
13:33:37 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
13:33:37 [INFO] websockets.server: server closing
13:33:37 [INFO] websockets.server: server closed
13:33:37 [INFO] gameserver.network.server: WebSocket server stopped
13:33:37 [INFO] __main__:   WebSocket server stopped
13:33:37 [INFO] __main__:   REST API server stopped
13:33:37 [INFO] __main__:   debug dashboard stopped
13:33:37 [INFO] __main__:   database closed
13:33:37 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:33:39 [INFO] __main__: === Game Server starting ===
13:33:39 [INFO] __main__: Loading configuration …
13:33:40 [INFO] __main__:   items:        235 loaded from config
13:33:40 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:33:40 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:33:40 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
13:33:40 [INFO] __main__:   game_config:  loaded
13:33:40 [INFO] __main__: Initializing persistence …
13:33:40 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:33:40 [INFO] __main__:   database:     connected (gameserver.db)
13:33:40 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:33:40 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:33:40 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:33:40 [INFO] __main__: Creating services …
13:33:40 [INFO] __main__:   upgrade_provider: 235 items registered
13:33:40 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:33:40 [INFO] __main__:   all services created
13:33:40 [INFO] __main__: Wiring event handlers …
13:33:40 [INFO] __main__:   event handlers registered
13:33:40 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:33:40 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:33:40 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:33:40 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:33:40 [INFO] __main__: Restored 2 empires from saved state
13:33:40 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:33:40 [INFO] __main__: Starting network servers …
13:33:40 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:33:40 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:33:40 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:33:40 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:33:41 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:33:41 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25860]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:33:41 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:33:41 [INFO] __main__: Starting game loop …
13:33:41 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     192.168.178.2:60567 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:33:42 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:33:42 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:33:42 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=travelling)
13:33:42 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:33:51 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:33:51 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-24' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:34:11 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:34:11 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:34:11 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-52' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:34:11 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:34:11 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:34:11 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:34:11 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:34:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:34:15 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:34:17 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:34:19 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:34:20 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7735.0)
13:34:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:34:23 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:34:23 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:34:23 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:34:23 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: HUNTING (10.2% of effort 20 = 2.0 culture)
13:34:23 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 120.1 (1.4%)
13:34:23 [INFO] gameserver.network.handlers: [LOOT] Life restored to uid=2: 1.00 (base=1.0 + effect=0.0)
13:34:23 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:34:40 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
13:34:40 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
13:35:48 [INFO] __main__: Shutdown signal received — stopping …
13:35:49 [INFO] __main__: Shutting down …
13:35:49 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
13:35:49 [INFO] websockets.server: server closing
13:35:49 [INFO] websockets.server: server closed
13:35:49 [INFO] gameserver.network.server: WebSocket server stopped
13:35:49 [INFO] __main__:   WebSocket server stopped
13:35:49 [INFO] __main__:   REST API server stopped
13:35:49 [INFO] __main__:   debug dashboard stopped
13:35:49 [INFO] __main__:   database closed
13:35:49 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

13:35:50 [INFO] __main__: === Game Server starting ===
13:35:50 [INFO] __main__: Loading configuration …
13:35:51 [INFO] __main__:   items:        235 loaded from config
13:35:51 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
13:35:51 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
13:35:51 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
13:35:51 [INFO] __main__:   game_config:  loaded
13:35:51 [INFO] __main__: Initializing persistence …
13:35:51 [INFO] gameserver.persistence.database: Database connected: gameserver.db
13:35:51 [INFO] __main__:   database:     connected (gameserver.db)
13:35:51 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
13:35:51 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
13:35:51 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
13:35:51 [INFO] __main__: Creating services …
13:35:51 [INFO] __main__:   upgrade_provider: 235 items registered
13:35:51 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
13:35:51 [INFO] __main__:   all services created
13:35:51 [INFO] __main__: Wiring event handlers …
13:35:51 [INFO] __main__:   event handlers registered
13:35:51 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
13:35:51 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
13:35:51 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
13:35:51 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
13:35:51 [INFO] __main__: Restored 2 empires from saved state
13:35:51 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
13:35:51 [INFO] __main__: Starting network servers …
13:35:51 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
13:35:51 [INFO] websockets.server: server listening on 0.0.0.0:8765
13:35:51 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
13:35:51 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
13:35:53 [INFO] gameserver.network.rest_api: REST API created with 28 routes
13:35:53 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [25978]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
13:35:53 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
13:35:53 [INFO] __main__: Starting game loop …
13:35:53 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
13:36:03 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
13:36:03 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-17' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
INFO:     192.168.178.2:60649 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
13:36:06 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
13:36:06 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
13:36:06 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
13:36:06 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
13:36:07 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
13:36:08 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
13:36:08 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-38' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
13:36:08 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
13:36:08 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
13:36:08 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
13:36:08 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
13:36:10 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
13:36:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
13:36:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
13:36:15 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
13:36:16 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7731.5)
13:36:17 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
13:36:20 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.0 -> 0.0 (damage: 1.0)
13:36:20 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
13:36:20 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
13:36:20 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: CRAFTSMANSHIP (8.5% of effort 200 = 17.0 culture)
13:36:20 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 173.1 (2.0%)
13:36:20 [INFO] gameserver.network.handlers: [LOOT] Life restored to uid=2: 1.00 (base=1.0 + effect=0.0)
13:36:20 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
13:36:27 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
13:36:27 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
13:48:29 [INFO] gameserver.network.auth: Login success: eem (uid=2)
13:51:45 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
13:51:45 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
13:51:47 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
13:51:47 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
13:51:50 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
13:51:50 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
13:51:54 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:51:54 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 2, 'free': 6}
13:51:55 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:51:55 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 3, 'free': 5}
13:51:56 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:51:56 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 4, 'free': 4}
13:51:59 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:51:59 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 5, 'free': 3}
13:52:00 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:52:00 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 6, 'free': 2}
13:52:00 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:52:00 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 7, 'free': 1}
13:52:01 [INFO] gameserver.network.handlers: change_citizen request from uid=2
13:52:01 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 3, 'artist': 8, 'free': 0}
13:54:07 [INFO] gameserver.network.handlers: new_item failed uid=2 iid=STABLES: Not enough gold (need 9000, have 7980.0)
13:54:09 [INFO] gameserver.engine.empire_service: Empire 2: started building LIBRARY (effort=18000.0)
13:54:09 [INFO] gameserver.network.handlers: new_item success uid=2 iid=LIBRARY
13:54:12 [INFO] gameserver.engine.empire_service: Empire 2: started research MATHMATICS (effort=11000.0)
13:54:12 [INFO] gameserver.network.handlers: new_item success uid=2 iid=MATHMATICS
14:03:47 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:47 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 7, 'artist': 4, 'free': 0}
14:03:49 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:49 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 9, 'artist': 2, 'free': 0}
14:03:50 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:50 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 10, 'artist': 1, 'free': 0}
14:03:52 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:52 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 6, 'artist': 5, 'free': 0}
14:03:54 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:54 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 9, 'artist': 2, 'free': 0}
14:03:57 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:03:57 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 5, 'artist': 6, 'free': 0}
14:04:05 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:04:05 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 7, 'artist': 4, 'free': 0}
14:04:08 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:04:08 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 3, 'scientist': 6, 'artist': 4, 'free': 0}
14:07:05 [INFO] __main__: Shutdown signal received — stopping …
14:07:05 [INFO] __main__: Shutting down …
14:07:05 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
14:07:05 [INFO] websockets.server: server closing
14:07:05 [INFO] websockets.server: server closed
14:07:05 [INFO] gameserver.network.server: WebSocket server stopped
14:07:05 [INFO] __main__:   WebSocket server stopped
14:07:05 [INFO] __main__:   REST API server stopped
14:07:05 [INFO] __main__:   debug dashboard stopped
14:07:05 [INFO] __main__:   database closed
14:07:05 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

14:07:07 [INFO] __main__: === Game Server starting ===
14:07:07 [INFO] __main__: Loading configuration …
14:07:08 [INFO] __main__:   items:        235 loaded from config
14:07:08 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
14:07:08 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
14:07:08 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
14:07:08 [INFO] __main__:   game_config:  loaded
14:07:08 [INFO] __main__: Initializing persistence …
14:07:08 [INFO] gameserver.persistence.database: Database connected: gameserver.db
14:07:08 [INFO] __main__:   database:     connected (gameserver.db)
14:07:08 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
14:07:08 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
14:07:08 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
14:07:08 [INFO] __main__: Creating services …
14:07:08 [INFO] __main__:   upgrade_provider: 235 items registered
14:07:08 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
14:07:08 [INFO] __main__:   all services created
14:07:08 [INFO] __main__: Wiring event handlers …
14:07:08 [INFO] __main__:   event handlers registered
14:07:08 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
14:07:08 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
14:07:08 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
14:07:08 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
14:07:08 [INFO] __main__: Restored 2 empires from saved state
14:07:08 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
14:07:08 [INFO] __main__: Starting network servers …
14:07:08 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
14:07:08 [INFO] websockets.server: server listening on 0.0.0.0:8765
14:07:08 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
14:07:08 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
14:07:09 [INFO] gameserver.network.rest_api: REST API created with 28 routes
14:07:09 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [27303]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
14:07:09 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
14:07:09 [INFO] __main__: Starting game loop …
14:07:09 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
14:07:19 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
14:07:19 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-18' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:07:25 [INFO] __main__: Shutdown signal received — stopping …
14:07:25 [INFO] __main__: Shutting down …
14:07:25 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
14:07:25 [INFO] websockets.server: server closing
14:07:25 [INFO] websockets.server: server closed
14:07:25 [INFO] gameserver.network.server: WebSocket server stopped
14:07:25 [INFO] __main__:   WebSocket server stopped
14:07:25 [INFO] __main__:   REST API server stopped
14:07:25 [INFO] __main__:   debug dashboard stopped
14:07:25 [INFO] __main__:   database closed
14:07:25 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

14:07:27 [INFO] __main__: === Game Server starting ===
14:07:27 [INFO] __main__: Loading configuration …
14:07:28 [INFO] __main__:   items:        235 loaded from config
14:07:28 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
14:07:28 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
14:07:28 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
14:07:28 [INFO] __main__:   game_config:  loaded
14:07:28 [INFO] __main__: Initializing persistence …
14:07:28 [INFO] gameserver.persistence.database: Database connected: gameserver.db
14:07:28 [INFO] __main__:   database:     connected (gameserver.db)
14:07:28 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
14:07:28 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
14:07:28 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
14:07:28 [INFO] __main__: Creating services …
14:07:28 [INFO] __main__:   upgrade_provider: 235 items registered
14:07:28 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
14:07:28 [INFO] __main__:   all services created
14:07:28 [INFO] __main__: Wiring event handlers …
14:07:28 [INFO] __main__:   event handlers registered
14:07:28 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
14:07:28 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
14:07:28 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
14:07:28 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
14:07:28 [INFO] __main__: Restored 2 empires from saved state
14:07:28 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
14:07:28 [INFO] __main__: Starting network servers …
14:07:28 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
14:07:28 [INFO] websockets.server: server listening on 0.0.0.0:8765
14:07:28 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
14:07:28 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
14:07:29 [INFO] gameserver.network.rest_api: REST API created with 28 routes
14:07:29 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [27380]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
14:07:29 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
14:07:29 [INFO] __main__: Starting game loop …
14:07:29 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
14:07:39 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
14:07:39 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-20' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:09:40 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
14:09:40 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-182' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:09:40 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
14:09:40 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
14:09:40 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
14:09:40 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
14:09:42 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
14:09:44 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
14:09:46 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
14:09:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
14:09:48 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7758.2)
14:09:49 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
14:09:52 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.1 -> 0.1 (damage: 1.0)
14:09:52 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
14:09:52 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
14:09:52 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: COPPER_BRONZE (6.3% of effort 2500 = 158.1 culture)
14:09:52 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 136.6 (1.6%)
14:09:52 [INFO] gameserver.network.handlers: [LOOT] Life restored to uid=2: 1.00 (base=1.0 + effect=0.0)
14:09:52 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
14:42:05 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
14:42:05 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
14:42:13 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:42:13 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 6, 'artist': 3}
14:42:18 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
14:42:18 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
14:44:06 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:44:06 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 5, 'scientist': 3, 'artist': 4}
14:44:08 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:44:08 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 5, 'scientist': 4, 'artist': 3}
14:44:11 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:44:11 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 5, 'scientist': 6, 'artist': 1}
14:48:11 [INFO] __main__: Shutdown signal received — stopping …
14:48:11 [INFO] __main__: Shutting down …
14:48:11 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
14:48:11 [INFO] websockets.server: server closing
14:48:11 [INFO] websockets.server: server closed
14:48:11 [INFO] gameserver.network.server: WebSocket server stopped
14:48:11 [INFO] __main__:   WebSocket server stopped
14:48:11 [INFO] __main__:   REST API server stopped
14:48:11 [INFO] __main__:   debug dashboard stopped
14:48:11 [INFO] __main__:   database closed
14:48:11 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

14:48:13 [INFO] __main__: === Game Server starting ===
14:48:13 [INFO] __main__: Loading configuration …
14:48:14 [INFO] __main__:   items:        235 loaded from config
14:48:14 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
14:48:14 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
14:48:14 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
14:48:14 [INFO] __main__:   game_config:  loaded
14:48:14 [INFO] __main__: Initializing persistence …
14:48:14 [INFO] gameserver.persistence.database: Database connected: gameserver.db
14:48:14 [INFO] __main__:   database:     connected (gameserver.db)
14:48:14 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
14:48:14 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
14:48:14 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
14:48:14 [INFO] __main__: Creating services …
14:48:14 [INFO] __main__:   upgrade_provider: 235 items registered
14:48:14 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
14:48:14 [INFO] __main__:   all services created
14:48:14 [INFO] __main__: Wiring event handlers …
14:48:14 [INFO] __main__:   event handlers registered
14:48:14 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
14:48:14 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
14:48:14 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
14:48:14 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
14:48:14 [INFO] __main__: Restored 2 empires from saved state
14:48:14 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
14:48:14 [INFO] __main__: Starting network servers …
14:48:14 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
14:48:14 [INFO] websockets.server: server listening on 0.0.0.0:8765
14:48:14 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
14:48:14 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
14:48:15 [INFO] gameserver.network.rest_api: REST API created with 28 routes
14:48:15 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [28355]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
14:48:15 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
14:48:15 [INFO] __main__: Starting game loop …
14:48:15 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
14:48:18 [INFO] gameserver.network.auth: Login success: eem (uid=2)
14:48:25 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
14:48:25 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-20' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:48:31 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
14:48:31 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
14:48:36 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:36 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 1, 'artist': 0}
14:48:38 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:38 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:40 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:40 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:42 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:42 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:44 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:44 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:46 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:46 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:47 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:47 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:48 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:48 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:48 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:48 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:52 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:52 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:56 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:48:56 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 0}
14:48:59 [INFO] gameserver.network.handlers: citizen_upgrade request from uid=2
14:48:59 [INFO] gameserver.network.handlers: citizen_upgrade success uid=2
14:49:03 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:03 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 1, 'artist': 0}
14:49:04 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:04 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:05 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:05 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:06 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:06 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:06 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:06 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:07 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:07 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:07 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:07 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:42 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:42 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:46 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:46 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:49:48 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:49:48 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:50:26 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
14:50:26 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-251' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:50:26 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
14:50:26 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
14:50:26 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
14:50:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
14:50:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
14:50:29 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
14:50:31 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
14:50:33 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
14:50:34 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7757.8)
14:50:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
14:50:38 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.1 -> 0.1 (damage: 1.0)
14:50:38 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
14:50:38 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
14:50:38 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: HUNTING (9.2% of effort 20 = 1.8 culture)
14:50:38 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 327.6 (3.8%)
14:50:38 [INFO] gameserver.network.handlers: [LOOT] Life restored to uid=2: 1.00 (base=1.0 + effect=0.0)
14:50:38 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
14:52:13 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:13 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:52:37 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:37 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 2, 'artist': 0}
14:52:38 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:38 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 1, 'artist': 1}
14:52:43 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:43 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 1, 'artist': 1}
14:52:45 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:45 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 2, 'artist': 0}
14:52:52 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:52 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:52:55 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:55 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 2, 'scientist': 0, 'artist': 0}
14:52:58 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:58 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 1, 'artist': 0}
14:52:59 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:52:59 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 1, 'scientist': 0, 'artist': 1}
14:53:01 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:53:01 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 1, 'artist': 1}
14:53:02 [INFO] gameserver.network.handlers: change_citizen request from uid=2
14:53:02 [INFO] gameserver.network.handlers: change_citizen success uid=2: {'merchant': 0, 'scientist': 2, 'artist': 0}
14:54:10 [INFO] __main__: Shutdown signal received — stopping …
14:54:10 [INFO] __main__: Shutting down …
14:54:10 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
14:54:10 [INFO] websockets.server: server closing
14:54:10 [INFO] websockets.server: server closed
14:54:10 [INFO] gameserver.network.server: WebSocket server stopped
14:54:10 [INFO] __main__:   WebSocket server stopped
14:54:10 [INFO] __main__:   REST API server stopped
14:54:10 [INFO] __main__:   debug dashboard stopped
14:54:10 [INFO] __main__:   database closed
14:54:10 [INFO] __main__:   goodbye
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

14:54:12 [INFO] __main__: === Game Server starting ===
14:54:12 [INFO] __main__: Loading configuration …
14:54:13 [INFO] __main__:   items:        235 loaded from config
14:54:13 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
14:54:13 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
14:54:13 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
14:54:13 [INFO] __main__:   game_config:  loaded
14:54:13 [INFO] __main__: Initializing persistence …
14:54:13 [INFO] gameserver.persistence.database: Database connected: gameserver.db
14:54:13 [INFO] __main__:   database:     connected (gameserver.db)
14:54:13 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
14:54:13 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
14:54:13 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
14:54:13 [INFO] __main__: Creating services …
14:54:13 [INFO] __main__:   upgrade_provider: 235 items registered
14:54:13 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
14:54:13 [INFO] __main__:   all services created
14:54:13 [INFO] __main__: Wiring event handlers …
14:54:13 [INFO] __main__:   event handlers registered
14:54:13 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
14:54:13 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
14:54:13 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
14:54:13 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
14:54:13 [INFO] __main__: Restored 2 empires from saved state
14:54:13 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
14:54:13 [INFO] __main__: Starting network servers …
14:54:13 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
14:54:13 [INFO] websockets.server: server listening on 0.0.0.0:8765
14:54:13 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
14:54:13 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
14:54:14 [INFO] gameserver.network.rest_api: REST API created with 28 routes
14:54:14 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [28667]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
14:54:14 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
14:54:14 [INFO] __main__: Starting game loop …
14:54:14 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
14:54:24 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
14:54:24 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-17' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
INFO:     192.168.178.2:53568 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:54:43 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:54:43 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:54:43 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
14:54:43 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
14:54:56 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:53580 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:54:57 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:54:57 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:54:57 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
14:54:57 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
14:55:03 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
14:55:03 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:53593 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:55:16 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:55:16 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:55:16 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
14:55:16 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
14:55:21 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
14:55:21 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
14:55:21 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-131' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:55:21 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
14:55:21 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
14:55:21 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
14:55:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
14:55:22 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
14:55:22 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
14:55:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
14:55:25 [INFO] gameserver.network.handlers: Tile 1,1 purchased by empire Empire1 (uid=2) for 131.9 gold
14:55:25 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
14:55:27 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
14:55:29 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
14:55:29 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7610.8)
14:55:30 [WARNING] gameserver.network.handlers: Map validation failed for Empire1 (uid=2): Map must contain exactly 1 castle (found 2)
14:55:31 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
14:55:33 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 1.1 -> 0.1 (damage: 1.0)
14:55:33 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender lost all life)
14:55:33 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=True
14:55:33 [INFO] gameserver.network.handlers: [LOOT] Knowledge stolen from uid=2: MUSIC (13.2% of effort 4000 = 527.1 culture)
14:55:33 [INFO] gameserver.network.handlers: [LOOT] Culture stolen from uid=2: 408.2 (4.7%)
14:55:33 [INFO] gameserver.network.handlers: [LOOT] Life restored to uid=2: 1.00 (base=1.0 + effect=0.0)
14:55:33 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
14:55:34 [INFO] gameserver.network.handlers: Map saved for empire Empire1 (uid=2): 5 tiles
INFO:     192.168.178.2:53611 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:55:36 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:55:36 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:55:36 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
14:56:02 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.2:53636 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:56:02 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:56:02 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:56:02 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
14:56:46 [INFO] __main__: Shutdown signal received — stopping …
14:56:46 [INFO] __main__: Shutting down …
14:56:46 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 0 attacks, 0 battles)
14:56:46 [INFO] websockets.server: server closing
14:56:46 [INFO] websockets.server: server closed
14:56:46 [INFO] gameserver.network.server: WebSocket server stopped
14:56:46 [INFO] __main__:   WebSocket server stopped
14:56:46 [INFO] __main__:   REST API server stopped
14:56:46 [INFO] __main__:   debug dashboard stopped
14:56:46 [INFO] __main__:   database closed
14:56:46 [INFO] __main__:   goodbye
INFO:     connection closed
ERROR:    Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 701, in lifespan
    await receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/lifespan/on.py", line 137, in receive
    return await self.receive_queue.get()
  File "/usr/lib/python3.9/asyncio/queues.py", line 166, in get
    await getter
asyncio.exceptions.CancelledError

ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 147, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 144, in app
    await func(session)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/fastapi/routing.py", line 509, in app
    await dependant.call(**solved_result.values)
  File "/home/pi/e3/python_server/src/gameserver/network/rest_api.py", line 396, in websocket_endpoint
    raw = await ws.receive_text()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 119, in receive_text
    message = await self.receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/starlette/websockets.py", line 47, in receive
    message = await self._receive()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 375, in asgi_receive
    data = await self.recv()
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/legacy/protocol.py", line 538, in recv
    await asyncio.wait(
  File "/usr/lib/python3.9/asyncio/tasks.py", line 413, in wait
    return await _wait(fs, timeout, return_when, loop)
  File "/usr/lib/python3.9/asyncio/tasks.py", line 529, in _wait
    await waiter
asyncio.exceptions.CancelledError
14:56:49 [INFO] __main__: === Game Server starting ===
14:56:49 [INFO] __main__: Loading configuration …
14:56:50 [INFO] __main__:   items:        235 loaded from config
14:56:50 [INFO] __main__:   map:          0 path tiles, 23 build tiles from config/maps/default.yaml
14:56:50 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
14:56:50 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (36 keys)
14:56:50 [INFO] __main__:   game_config:  loaded
14:56:50 [INFO] __main__: Initializing persistence …
14:56:50 [INFO] gameserver.persistence.database: Database connected: gameserver.db
14:56:50 [INFO] __main__:   database:     connected (gameserver.db)
14:56:50 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
14:56:50 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
14:56:50 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
14:56:50 [INFO] __main__: Creating services …
14:56:50 [INFO] __main__:   upgrade_provider: 235 items registered
14:56:50 [INFO] gameserver.persistence.message_store: MessageStore: loaded 1 messages from messages.yaml
14:56:50 [INFO] __main__:   all services created
14:56:50 [INFO] __main__: Wiring event handlers …
14:56:50 [INFO] __main__:   event handlers registered
14:56:50 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
14:56:50 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0}
14:56:50 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
14:56:50 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'incoming_siege_time_offset': 3600.0, 'restore_life_after_loss': 5.0, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
14:56:50 [INFO] __main__: Restored 2 empires from saved state
14:56:50 [INFO] gameserver.engine.attack_service: Restored 1 attacks; next_attack_id set to 2
14:56:50 [INFO] __main__: Starting network servers …
14:56:50 [INFO] gameserver.network.handlers: Registered 32 message handlers: ping, summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
14:56:50 [INFO] websockets.server: server listening on 0.0.0.0:8765
14:56:50 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
14:56:50 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
14:56:51 [INFO] gameserver.network.rest_api: REST API created with 28 routes
14:56:51 [INFO] __main__:   REST API listening on http://0.0.0.0:8080
INFO:     Started server process [28816]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
14:56:51 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
14:56:51 [INFO] __main__: Starting game loop …
14:56:51 [INFO] __main__:   game loop running (1 s tick)
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
14:57:01 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
14:57:01 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-23' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
INFO:     192.168.178.2:53684 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:57:01 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:57:01 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:57:01 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
14:57:01 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
14:57:02 [INFO] gameserver.engine.attack_service: Siege skipped: attack_id=1 defender=2 attacker=100
14:57:03 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
14:57:03 [ERROR] asyncio: Task exception was never retrieved
future: <Task finished name='Task-37' coro=<_create_attack_phase_handler.<locals>._async_phase_changed() done, defined at /home/pi/e3/python_server/src/gameserver/network/handlers.py:1892> exception=AttributeError("'AttackService' object has no attribute 'get_all'")>
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1917, in _async_phase_changed
    for a in svc.attack_service.get_all():
AttributeError: 'AttackService' object has no attribute 'get_all'
14:57:03 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
14:57:03 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
14:57:03 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=100)
14:57:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (WARRIOR) spawned from wave 1 (progress=1/6, path_length=3)
14:57:03 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
14:57:03 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
14:57:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (WARRIOR) spawned from wave 1 (progress=2/6, path_length=3)
14:57:05 [INFO] gameserver.network.handlers: Tile 1,1 purchased by empire Empire1 (uid=2) for 131.9 gold
14:57:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (WARRIOR) spawned from wave 1 (progress=3/6, path_length=3)
14:57:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (WARRIOR) spawned from wave 1 (progress=4/6, path_length=3)
14:57:11 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (WARRIOR) spawned from wave 1 (progress=5/6, path_length=3)
14:57:11 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=1 (WARRIOR) killed — defender awarded 2.0 gold (total: 7598.7)
14:57:11 [INFO] gameserver.network.handlers: Map saved for empire Empire1 (uid=2): 5 tiles
14:57:11 [INFO] gameserver.network.handlers: Map saved for empire Empire1 (uid=2): 5 tiles
14:57:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (WARRIOR) spawned from wave 1 (progress=6/6, path_length=3)
INFO:     192.168.178.2:56549 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:57:13 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:57:13 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:57:13 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_battle)
14:57:13 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
14:57:15 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=2 (WARRIOR) reached goal, defender life: 10.0 -> 9.0 (damage: 1.0)
14:57:17 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=3 (WARRIOR) reached goal, defender life: 9.0 -> 8.0 (damage: 1.0)
14:57:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4, path_length=3)
14:57:19 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=4 (WARRIOR) reached goal, defender life: 8.0 -> 7.0 (damage: 1.0)
14:57:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4, path_length=3)
14:57:21 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=5 (WARRIOR) reached goal, defender life: 7.0 -> 6.0 (damage: 1.0)
14:57:23 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=6 (WARRIOR) reached goal, defender life: 6.0 -> 5.0 (damage: 1.0)
14:57:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4, path_length=3)
14:57:25 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=7 (SLAVE) killed — defender awarded 1.0 gold (total: 7602.8)
14:57:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4, path_length=3)
14:57:27 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=8 (SLAVE) killed — defender awarded 1.0 gold (total: 7604.2)
14:57:29 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=9 (SLAVE) killed — defender awarded 1.0 gold (total: 7605.6)
14:57:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=11 (WARRIOR) spawned from wave 3 (progress=1/4, path_length=3)
14:57:32 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=10 (SLAVE) killed — defender awarded 1.0 gold (total: 7607.3)
14:57:34 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=12 (WARRIOR) spawned from wave 3 (progress=2/4, path_length=3)
14:57:36 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=13 (WARRIOR) spawned from wave 3 (progress=3/4, path_length=3)
14:57:38 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=14 (WARRIOR) spawned from wave 3 (progress=4/4, path_length=3)
14:57:40 [INFO] gameserver.engine.battle_service: [KILLED] Critter cid=11 (WARRIOR) killed — defender awarded 2.0 gold (total: 7611.1)
14:57:43 [INFO] gameserver.network.handlers: battle_unregister: uid=2 unregistered from attack 1
14:57:43 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
14:57:44 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=12 (WARRIOR) reached goal, defender life: 5.0 -> 4.0 (damage: 1.0)
14:57:46 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=13 (WARRIOR) reached goal, defender life: 4.0 -> 3.0 (damage: 1.0)
14:57:48 [INFO] gameserver.engine.battle_service: [FINISHED] Critter cid=14 (WARRIOR) reached goal, defender life: 3.0 -> 2.0 (damage: 1.0)
14:57:48 [INFO] gameserver.engine.battle_service: [FINISH] Battle bid=1 finished (defender won)
14:57:48 [INFO] gameserver.network.handlers: [battle] bid=1 complete: attacker_wins=False
14:57:48 [INFO] gameserver.network.handlers: [battle] Attack 1 marked as FINISHED
INFO:     192.168.178.2:56636 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTcwNjIzMCwiZXhwIjoxNzcxNzkyNjMwfQ.J8ILtNkfNFO0F1lw48S6ShZQ_Mrc8RiMlop53WCxhUc" [accepted]
14:59:34 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
14:59:34 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
14:59:34 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
15:00:15 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
15:00:15 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.25:64872 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTc2ODA5OCwiZXhwIjoxNzcxODU0NDk4fQ.CAk6vN8louY_ChFSULXGPQTu4VWmk1qaaQHOo_1KP3w" [accepted]
15:02:05 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
15:02:05 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
15:02:05 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
15:02:17 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
15:02:17 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
INFO:     192.168.178.25:64884 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIsImlhdCI6MTc3MTc2ODA5OCwiZXhwIjoxNzcxODU0NDk4fQ.CAk6vN8louY_ChFSULXGPQTu4VWmk1qaaQHOo_1KP3w" [accepted]
15:03:05 [INFO] gameserver.network.server: Session registered: uid=2
INFO:     connection open
15:03:05 [INFO] gameserver.network.rest_api: REST-WS client connected: uid=2
15:03:05 [WARNING] gameserver.network.handlers: battle_register: no attack found for uid=2 target=2
15:03:09 [WARNING] gameserver.network.handlers: battle_unregister: uid=2 not registered for any attack
15:03:09 [INFO] gameserver.network.rest_api: REST-WS client disconnected: uid=2
INFO:     connection closed
