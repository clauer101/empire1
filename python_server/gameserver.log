20:03:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:03:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=3/4)
20:03:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:03:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=4/4)
20:03:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:04:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:04:08 [INFO] __main__: Shutdown signal received — stopping …
20:04:09 [INFO] __main__: Shutting down …
20:04:09 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:04:09 [INFO] websockets.server: server closing
20:04:09 [INFO] websockets.server: server closed
20:04:09 [INFO] gameserver.network.server: WebSocket server stopped
20:04:09 [INFO] __main__:   WebSocket server stopped
20:04:09 [INFO] __main__:   debug dashboard stopped
20:04:09 [INFO] __main__:   database closed
20:04:09 [INFO] __main__:   goodbye
20:04:10 [INFO] __main__: === Game Server starting ===
20:04:10 [INFO] __main__: Loading configuration …
20:04:11 [INFO] __main__:   items:        210 loaded from config
20:04:11 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:04:11 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:04:11 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:04:11 [INFO] __main__:   game_config:  loaded
20:04:11 [INFO] __main__: Initializing persistence …
20:04:11 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:04:11 [INFO] __main__:   database:     connected (gameserver.db)
20:04:11 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:04:11 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:04:11 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:04:11 [INFO] __main__: Creating services …
20:04:11 [INFO] __main__:   upgrade_provider: 210 items registered
20:04:11 [INFO] __main__:   all services created
20:04:11 [INFO] __main__: Wiring event handlers …
20:04:11 [INFO] __main__:   event handlers registered
20:04:11 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:04:11 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:04:11 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:04:11 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:04:11 [INFO] __main__: Restored 2 empires from saved state
20:04:11 [INFO] __main__: Restored 1 attacks from saved state
20:04:11 [INFO] __main__: Starting network server …
20:04:11 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:04:11 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:04:11 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:04:11 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:04:11 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:04:11 [INFO] __main__: Starting game loop …
20:04:11 [INFO] __main__:   game loop running (1 s tick)
20:04:11 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:04:12 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:04:12 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:04:12 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:04:12 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:04:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:04:12 [INFO] gameserver.engine.battle_service: Next wave starting: wave_pointer=0 -> 1
20:04:12 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SLAVE) spawned from wave 2 (progress=1/4)
20:04:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:04:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SLAVE) spawned from wave 2 (progress=2/4)
20:04:16 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:04:16 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=3/4)
20:04:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:04:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=4/4)
20:04:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:04:22 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:05:27 [INFO] __main__: Shutdown signal received — stopping …
20:05:27 [INFO] __main__: Shutting down …
20:05:27 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:05:27 [INFO] websockets.server: server closing
20:05:27 [INFO] websockets.server: server closed
20:05:27 [INFO] gameserver.network.server: WebSocket server stopped
20:05:27 [INFO] __main__:   WebSocket server stopped
20:05:27 [INFO] __main__:   debug dashboard stopped
20:05:27 [INFO] __main__:   database closed
20:05:27 [INFO] __main__:   goodbye
20:05:29 [INFO] __main__: === Game Server starting ===
20:05:29 [INFO] __main__: Loading configuration …
20:05:30 [INFO] __main__:   items:        210 loaded from config
20:05:30 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:05:30 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:05:30 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:05:30 [INFO] __main__:   game_config:  loaded
20:05:30 [INFO] __main__: Initializing persistence …
20:05:30 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:05:30 [INFO] __main__:   database:     connected (gameserver.db)
20:05:30 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:05:30 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:05:30 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:05:30 [INFO] __main__: Creating services …
20:05:30 [INFO] __main__:   upgrade_provider: 210 items registered
20:05:30 [INFO] __main__:   all services created
20:05:30 [INFO] __main__: Wiring event handlers …
20:05:30 [INFO] __main__:   event handlers registered
20:05:30 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:05:30 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:05:30 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:05:30 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:05:30 [INFO] __main__: Restored 2 empires from saved state
20:05:30 [INFO] __main__: Restored 1 attacks from saved state
20:05:30 [INFO] __main__: Starting network server …
20:05:30 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:05:30 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:05:30 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:05:30 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:05:30 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:05:30 [INFO] __main__: Starting game loop …
20:05:30 [INFO] __main__:   game loop running (1 s tick)
20:05:30 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:05:31 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:05:31 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:05:31 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:05:31 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:05:31 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:05:31 [INFO] gameserver.engine.battle_service: Next wave starting: wave_pointer=0 -> 1
20:05:31 [ERROR] gameserver.network.handlers: Battle loop crashed: Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/network/handlers.py", line 1452, in _run_battle_task
    await battle_svc.run_battle(battle, send_fn, broadcast_interval_ms)
  File "/home/pi/e3/python_server/src/gameserver/engine/battle_service.py", line 163, in run_battle
    self.tick(battle, dt_ms)
  File "/home/pi/e3/python_server/src/gameserver/engine/battle_service.py", line 181, in tick
    self._step_armies(battle, dt_ms)
  File "/home/pi/e3/python_server/src/gameserver/engine/battle_service.py", line 383, in _step_armies
    army.next_wave_ms = self._get_wave_interval(wave)
UnboundLocalError: local variable 'wave' referenced before assignment

20:06:41 [INFO] __main__: Shutdown signal received — stopping …
20:06:42 [INFO] __main__: Shutting down …
20:06:42 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:06:42 [INFO] websockets.server: server closing
20:06:42 [INFO] websockets.server: server closed
20:06:42 [INFO] gameserver.network.server: WebSocket server stopped
20:06:42 [INFO] __main__:   WebSocket server stopped
20:06:42 [INFO] __main__:   debug dashboard stopped
20:06:42 [INFO] __main__:   database closed
20:06:42 [INFO] __main__:   goodbye
20:06:43 [INFO] __main__: === Game Server starting ===
20:06:43 [INFO] __main__: Loading configuration …
20:06:44 [INFO] __main__:   items:        210 loaded from config
20:06:44 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:06:44 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:06:44 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:06:44 [INFO] __main__:   game_config:  loaded
20:06:44 [INFO] __main__: Initializing persistence …
20:06:44 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:06:44 [INFO] __main__:   database:     connected (gameserver.db)
20:06:44 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:06:44 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:06:44 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:06:44 [INFO] __main__: Creating services …
20:06:44 [INFO] __main__:   upgrade_provider: 210 items registered
20:06:44 [INFO] __main__:   all services created
20:06:44 [INFO] __main__: Wiring event handlers …
20:06:44 [INFO] __main__:   event handlers registered
20:06:44 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:06:44 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:06:44 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:06:44 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:06:44 [INFO] __main__: Restored 2 empires from saved state
20:06:44 [INFO] __main__: Restored 1 attacks from saved state
20:06:44 [INFO] __main__: Starting network server …
20:06:44 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:06:44 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:06:44 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:06:44 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:06:44 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:06:44 [INFO] __main__: Starting game loop …
20:06:44 [INFO] __main__:   game loop running (1 s tick)
20:06:44 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:06:45 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:06:45 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:06:45 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:06:45 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:06:45 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:06:45 [INFO] gameserver.engine.battle_service: Next wave starting: wave_pointer=0 -> 1
20:06:45 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SLAVE) spawned from wave 2 (progress=1/4)
20:06:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:06:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SLAVE) spawned from wave 2 (progress=2/4)
20:06:49 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:06:49 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=3/4)
20:06:51 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:06:51 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=4/4)
20:06:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:06:55 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:07:10 [INFO] __main__: Shutdown signal received — stopping …
20:07:10 [INFO] __main__: Shutting down …
20:07:10 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:07:10 [INFO] websockets.server: server closing
20:07:10 [INFO] websockets.server: server closed
20:07:10 [INFO] gameserver.network.server: WebSocket server stopped
20:07:10 [INFO] __main__:   WebSocket server stopped
20:07:10 [INFO] __main__:   debug dashboard stopped
20:07:10 [INFO] __main__:   database closed
20:07:10 [INFO] __main__:   goodbye
20:07:12 [INFO] __main__: === Game Server starting ===
20:07:12 [INFO] __main__: Loading configuration …
20:07:13 [INFO] __main__:   items:        210 loaded from config
20:07:13 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:07:13 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:07:13 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:07:13 [INFO] __main__:   game_config:  loaded
20:07:13 [INFO] __main__: Initializing persistence …
20:07:13 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:07:13 [INFO] __main__:   database:     connected (gameserver.db)
20:07:13 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:07:13 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:07:13 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:07:13 [INFO] __main__: Creating services …
20:07:13 [INFO] __main__:   upgrade_provider: 210 items registered
20:07:13 [INFO] __main__:   all services created
20:07:13 [INFO] __main__: Wiring event handlers …
20:07:13 [INFO] __main__:   event handlers registered
20:07:13 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:07:13 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:07:13 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:07:13 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:07:13 [INFO] __main__: Restored 2 empires from saved state
20:07:13 [INFO] __main__: Restored 1 attacks from saved state
20:07:13 [INFO] __main__: Starting network server …
20:07:13 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:07:13 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:07:13 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:07:13 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:07:13 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:07:13 [INFO] __main__: Starting game loop …
20:07:13 [INFO] __main__:   game loop running (1 s tick)
20:07:13 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:07:14 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:07:14 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:07:14 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:07:14 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:07:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:07:14 [INFO] gameserver.engine.battle_service: Next wave starting: wave_pointer=0 -> 1
20:07:14 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SLAVE) spawned from wave 2 (progress=1/4)
20:07:16 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:07:16 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SLAVE) spawned from wave 2 (progress=2/4)
20:07:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:07:18 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=3/4)
20:07:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:07:20 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=4/4)
20:07:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:07:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:28:29 [INFO] __main__: Shutdown signal received — stopping …
20:28:30 [INFO] __main__: Shutting down …
20:28:30 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:28:30 [INFO] websockets.server: server closing
20:28:30 [INFO] websockets.server: server closed
20:28:30 [INFO] gameserver.network.server: WebSocket server stopped
20:28:30 [INFO] __main__:   WebSocket server stopped
20:28:30 [INFO] __main__:   debug dashboard stopped
20:28:30 [INFO] __main__:   database closed
20:28:30 [INFO] __main__:   goodbye
20:28:32 [INFO] __main__: === Game Server starting ===
20:28:32 [INFO] __main__: Loading configuration …
20:28:33 [INFO] __main__:   items:        210 loaded from config
20:28:33 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:28:33 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:28:33 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:28:33 [INFO] __main__:   game_config:  loaded
20:28:33 [INFO] __main__: Initializing persistence …
20:28:33 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:28:33 [INFO] __main__:   database:     connected (gameserver.db)
20:28:33 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:28:33 [ERROR] gameserver.persistence.state_load: Failed to restore empire: 100
Traceback (most recent call last):
  File "/home/pi/e3/python_server/src/gameserver/persistence/state_load.py", line 89, in load_state
    empire = _deserialize_empire(empire_dict)
  File "/home/pi/e3/python_server/src/gameserver/persistence/state_load.py", line 142, in _deserialize_empire
    armies = [_deserialize_army(a) for a in d.get("armies", [])]
  File "/home/pi/e3/python_server/src/gameserver/persistence/state_load.py", line 142, in <listcomp>
    armies = [_deserialize_army(a) for a in d.get("armies", [])]
  File "/home/pi/e3/python_server/src/gameserver/persistence/state_load.py", line 217, in _deserialize_army
    return Army(
TypeError: __init__() got an unexpected keyword argument 'current_wave_pointer'
20:28:33 [INFO] gameserver.persistence.state_load: Restored 1 empires, 1 attacks, 0 battles
20:28:33 [INFO] __main__:   state:        restored from disk (1 empires, 1 attacks)
20:28:33 [INFO] __main__: Creating services …
20:28:33 [INFO] __main__:   upgrade_provider: 210 items registered
20:28:33 [INFO] __main__:   all services created
20:28:33 [INFO] __main__: Wiring event handlers …
20:28:33 [INFO] __main__:   event handlers registered
20:28:33 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:28:33 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:28:33 [INFO] __main__: Restored 1 empires from saved state
20:28:33 [INFO] __main__: Restored 1 attacks from saved state
20:28:33 [INFO] __main__: Starting network server …
20:28:33 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:28:33 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:28:33 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:28:33 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:28:33 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:28:33 [INFO] __main__: Starting game loop …
20:28:33 [INFO] __main__:   game loop running (1 s tick)
20:28:33 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:28:34 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:28:34 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:28:34 [ERROR] gameserver.network.handlers: [battle:start_requested] FAIL: attacker 100 not found
20:30:17 [INFO] __main__: Shutdown signal received — stopping …
20:30:17 [INFO] __main__: Shutting down …
20:30:17 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (1 empires, 1 attacks, 0 battles)
20:30:17 [INFO] websockets.server: server closing
20:30:17 [INFO] websockets.server: server closed
20:30:17 [INFO] gameserver.network.server: WebSocket server stopped
20:30:17 [INFO] __main__:   WebSocket server stopped
20:30:17 [INFO] __main__:   debug dashboard stopped
20:30:17 [INFO] __main__:   database closed
20:30:17 [INFO] __main__:   goodbye
20:30:19 [INFO] __main__: === Game Server starting ===
20:30:19 [INFO] __main__: Loading configuration …
20:30:19 [INFO] __main__:   items:        210 loaded from config
20:30:19 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:30:19 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:30:19 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:30:19 [INFO] __main__:   game_config:  loaded
20:30:19 [INFO] __main__: Initializing persistence …
20:30:19 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:30:19 [INFO] __main__:   database:     connected (gameserver.db)
20:30:20 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:30:20 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:30:20 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:30:20 [INFO] __main__: Creating services …
20:30:20 [INFO] __main__:   upgrade_provider: 210 items registered
20:30:20 [INFO] __main__:   all services created
20:30:20 [INFO] __main__: Wiring event handlers …
20:30:20 [INFO] __main__:   event handlers registered
20:30:20 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:30:20 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:30:20 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:30:20 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:30:20 [INFO] __main__: Restored 2 empires from saved state
20:30:20 [INFO] __main__: Restored 1 attacks from saved state
20:30:20 [INFO] __main__: Starting network server …
20:30:20 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:30:20 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:30:20 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:30:20 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:30:20 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:30:20 [INFO] __main__: Starting game loop …
20:30:20 [INFO] __main__:   game loop running (1 s tick)
20:30:20 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:30:21 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:30:21 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:30:21 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:30:21 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:30:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:30:22 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:30:24 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:30:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:30:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:30:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=1/4)
20:30:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:30:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:30:34 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:30:36 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:30:54 [INFO] __main__: Shutdown signal received — stopping …
20:30:55 [INFO] __main__: Shutting down …
20:30:55 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:30:55 [INFO] websockets.server: server closing
20:30:55 [INFO] websockets.server: server closed
20:30:55 [INFO] gameserver.network.server: WebSocket server stopped
20:30:55 [INFO] __main__:   WebSocket server stopped
20:30:55 [INFO] __main__:   debug dashboard stopped
20:30:55 [INFO] __main__:   database closed
20:30:55 [INFO] __main__:   goodbye
20:30:56 [INFO] __main__: === Game Server starting ===
20:30:56 [INFO] __main__: Loading configuration …
20:30:56 [INFO] __main__:   items:        210 loaded from config
20:30:57 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:30:57 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:30:57 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:30:57 [INFO] __main__:   game_config:  loaded
20:30:57 [INFO] __main__: Initializing persistence …
20:30:57 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:30:57 [INFO] __main__:   database:     connected (gameserver.db)
20:30:57 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:30:57 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:30:57 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:30:57 [INFO] __main__: Creating services …
20:30:57 [INFO] __main__:   upgrade_provider: 210 items registered
20:30:57 [INFO] __main__:   all services created
20:30:57 [INFO] __main__: Wiring event handlers …
20:30:57 [INFO] __main__:   event handlers registered
20:30:57 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:30:57 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:30:57 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:30:57 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:30:57 [INFO] __main__: Restored 2 empires from saved state
20:30:57 [INFO] __main__: Restored 1 attacks from saved state
20:30:57 [INFO] __main__: Starting network server …
20:30:57 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:30:57 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:30:57 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:30:57 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:30:57 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:30:57 [INFO] __main__: Starting game loop …
20:30:57 [INFO] __main__:   game loop running (1 s tick)
20:30:57 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:30:58 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:30:58 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:30:58 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:30:58 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:30:58 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:31:00 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:31:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:31:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:31:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:31:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:31:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4)
20:31:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:31:11 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:31:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:32:49 [INFO] __main__: Shutdown signal received — stopping …
20:32:50 [INFO] __main__: Shutting down …
20:32:50 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:32:50 [INFO] websockets.server: server closing
20:32:50 [INFO] websockets.server: server closed
20:32:50 [INFO] gameserver.network.server: WebSocket server stopped
20:32:50 [INFO] __main__:   WebSocket server stopped
20:32:50 [INFO] __main__:   debug dashboard stopped
20:32:50 [INFO] __main__:   database closed
20:32:50 [INFO] __main__:   goodbye
20:32:52 [INFO] __main__: === Game Server starting ===
20:32:52 [INFO] __main__: Loading configuration …
20:32:53 [INFO] __main__:   items:        210 loaded from config
20:32:53 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:32:53 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:32:53 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:32:53 [INFO] __main__:   game_config:  loaded
20:32:53 [INFO] __main__: Initializing persistence …
20:32:53 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:32:53 [INFO] __main__:   database:     connected (gameserver.db)
20:32:53 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:32:53 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:32:53 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:32:53 [INFO] __main__: Creating services …
20:32:53 [INFO] __main__:   upgrade_provider: 210 items registered
20:32:53 [INFO] __main__:   all services created
20:32:53 [INFO] __main__: Wiring event handlers …
20:32:53 [INFO] __main__:   event handlers registered
20:32:53 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:32:53 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:32:53 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:32:53 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:32:53 [INFO] __main__: Restored 2 empires from saved state
20:32:53 [INFO] __main__: Restored 1 attacks from saved state
20:32:53 [INFO] __main__: Starting network server …
20:32:53 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:32:53 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:32:53 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:32:53 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:32:53 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:32:53 [INFO] __main__: Starting game loop …
20:32:53 [INFO] __main__:   game loop running (1 s tick)
20:32:53 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:32:53 [INFO] websockets.server: connection open
20:32:53 [INFO] gameserver.network.server: Session registered: uid=-1
20:32:53 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 56648)
20:32:54 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:32:54 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:32:54 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:32:54 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:32:54 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:32:56 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:32:56 [INFO] gameserver.network.auth: Login failed — unknown user: ee
20:32:58 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:32:58 [ERROR] websockets.server: opening handshake failed
Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/http11.py", line 138, in parse
    request_line = yield from parse_line(read_line)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/http11.py", line 309, in parse_line
    line = yield from read_line(MAX_LINE_LENGTH)
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/streams.py", line 46, in read_line
    raise EOFError(f"stream ends after {p} bytes, before end of line")
EOFError: stream ends after 0 bytes, before end of line

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/server.py", line 545, in parse
    request = yield from Request.parse(
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/http11.py", line 140, in parse
    raise EOFError("connection closed while reading HTTP request line") from exc
EOFError: connection closed while reading HTTP request line

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/home/pi/e3/.venv/lib/python3.9/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
websockets.exceptions.InvalidMessage: did not receive a valid HTTP request
20:32:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:33:00 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:33:00 [INFO] gameserver.network.server: Session registered: uid=2
20:33:00 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:33:01 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:33:01 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_battle)
20:33:01 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
20:33:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=1/4)
20:33:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:33:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:33:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:33:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:34:07 [INFO] __main__: Shutdown signal received — stopping …
20:34:07 [INFO] __main__: Shutting down …
20:34:07 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:34:07 [INFO] websockets.server: server closing
20:34:07 [INFO] gameserver.network.server: Session removed: uid=2
20:34:07 [INFO] websockets.server: server closed
20:34:07 [INFO] gameserver.network.server: WebSocket server stopped
20:34:07 [INFO] __main__:   WebSocket server stopped
20:34:07 [INFO] __main__:   debug dashboard stopped
20:34:07 [INFO] __main__:   database closed
20:34:07 [INFO] __main__:   goodbye
20:34:09 [INFO] __main__: === Game Server starting ===
20:34:09 [INFO] __main__: Loading configuration …
20:34:09 [INFO] __main__:   items:        210 loaded from config
20:34:09 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:34:09 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:34:09 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:34:09 [INFO] __main__:   game_config:  loaded
20:34:09 [INFO] __main__: Initializing persistence …
20:34:09 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:34:09 [INFO] __main__:   database:     connected (gameserver.db)
20:34:09 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:34:09 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:34:09 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:34:09 [INFO] __main__: Creating services …
20:34:09 [INFO] __main__:   upgrade_provider: 210 items registered
20:34:09 [INFO] __main__:   all services created
20:34:09 [INFO] __main__: Wiring event handlers …
20:34:09 [INFO] __main__:   event handlers registered
20:34:09 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:34:09 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:34:09 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:34:09 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:34:09 [INFO] __main__: Restored 2 empires from saved state
20:34:09 [INFO] __main__: Restored 1 attacks from saved state
20:34:09 [INFO] __main__: Starting network server …
20:34:09 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:34:09 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:34:09 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:34:09 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:34:09 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:34:09 [INFO] __main__: Starting game loop …
20:34:09 [INFO] __main__:   game loop running (1 s tick)
20:34:10 [INFO] websockets.server: connection open
20:34:10 [INFO] gameserver.network.server: Session registered: uid=-1
20:34:10 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 56689)
20:34:10 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:34:10 [INFO] gameserver.network.server: Session registered: uid=2
20:34:10 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:34:10 [INFO] gameserver.network.server: Session removed: uid=2
20:34:10 [INFO] websockets.server: connection open
20:34:10 [INFO] gameserver.network.server: Session registered: uid=-2
20:34:10 [INFO] gameserver.network.server: Client connected: uid=-2 remote=('192.168.178.2', 56691)
20:34:10 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:34:10 [INFO] gameserver.network.server: Session registered: uid=2
20:34:10 [INFO] gameserver.network.server: Session upgraded: guest=-2 → uid=2
20:34:14 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:34:16 [INFO] gameserver.network.handlers: battle_register: uid=2 registered for attack 1 (phase=in_siege)
20:34:16 [INFO] gameserver.network.handlers: _send_battle_setup: sent to uid=2 (attack_id=1)
20:34:19 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:34:19 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:34:19 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:34:19 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:34:19 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:34:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:34:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:34:25 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:34:27 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:34:29 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SLAVE) spawned from wave 2 (progress=1/4)
20:34:29 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:34:31 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:34:33 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:34:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:34:50 [INFO] __main__: Shutdown signal received — stopping …
20:34:50 [INFO] __main__: Shutting down …
20:34:51 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:34:51 [INFO] websockets.server: server closing
20:34:51 [INFO] gameserver.network.server: Session removed: uid=2
20:34:51 [INFO] websockets.server: server closed
20:34:51 [INFO] gameserver.network.server: WebSocket server stopped
20:34:51 [INFO] __main__:   WebSocket server stopped
20:34:51 [INFO] __main__:   debug dashboard stopped
20:34:51 [INFO] __main__:   database closed
20:34:51 [INFO] __main__:   goodbye
20:34:52 [INFO] __main__: === Game Server starting ===
20:34:52 [INFO] __main__: Loading configuration …
20:34:53 [INFO] __main__:   items:        210 loaded from config
20:34:53 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:34:53 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:34:53 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:34:53 [INFO] __main__:   game_config:  loaded
20:34:53 [INFO] __main__: Initializing persistence …
20:34:53 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:34:53 [INFO] __main__:   database:     connected (gameserver.db)
20:34:53 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:34:53 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:34:53 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:34:53 [INFO] __main__: Creating services …
20:34:53 [INFO] __main__:   upgrade_provider: 210 items registered
20:34:53 [INFO] __main__:   all services created
20:34:53 [INFO] __main__: Wiring event handlers …
20:34:53 [INFO] __main__:   event handlers registered
20:34:53 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:34:53 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:34:53 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:34:53 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:34:53 [INFO] __main__: Restored 2 empires from saved state
20:34:53 [INFO] __main__: Restored 1 attacks from saved state
20:34:53 [INFO] __main__: Starting network server …
20:34:53 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:34:53 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:34:53 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:34:53 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:34:53 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:34:53 [INFO] __main__: Starting game loop …
20:34:53 [INFO] __main__:   game loop running (1 s tick)
20:34:54 [INFO] websockets.server: connection open
20:34:54 [INFO] gameserver.network.server: Session registered: uid=-1
20:34:54 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 56711)
20:34:54 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:34:54 [INFO] gameserver.network.server: Session registered: uid=2
20:34:54 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:34:58 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:35:03 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:35:03 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:35:03 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:35:03 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:35:03 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:35:05 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:35:07 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:35:09 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:35:11 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:35:13 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:35:17 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4)
20:35:19 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:35:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:35:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:36:14 [INFO] __main__: Shutdown signal received — stopping …
20:36:15 [INFO] __main__: Shutting down …
20:36:15 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:36:15 [INFO] websockets.server: server closing
20:36:15 [INFO] gameserver.network.server: Session removed: uid=2
20:36:15 [INFO] websockets.server: server closed
20:36:15 [INFO] gameserver.network.server: WebSocket server stopped
20:36:15 [INFO] __main__:   WebSocket server stopped
20:36:15 [INFO] __main__:   debug dashboard stopped
20:36:15 [INFO] __main__:   database closed
20:36:15 [INFO] __main__:   goodbye
20:36:16 [INFO] __main__: === Game Server starting ===
20:36:16 [INFO] __main__: Loading configuration …
20:36:17 [INFO] __main__:   items:        210 loaded from config
20:36:17 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:36:17 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:36:17 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:36:17 [INFO] __main__:   game_config:  loaded
20:36:17 [INFO] __main__: Initializing persistence …
20:36:17 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:36:17 [INFO] __main__:   database:     connected (gameserver.db)
20:36:17 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:36:17 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:36:17 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:36:17 [INFO] __main__: Creating services …
20:36:17 [INFO] __main__:   upgrade_provider: 210 items registered
20:36:17 [INFO] __main__:   all services created
20:36:17 [INFO] __main__: Wiring event handlers …
20:36:17 [INFO] __main__:   event handlers registered
20:36:17 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:36:17 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:36:17 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:36:17 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:36:17 [INFO] __main__: Restored 2 empires from saved state
20:36:17 [INFO] __main__: Restored 1 attacks from saved state
20:36:17 [INFO] __main__: Starting network server …
20:36:17 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:36:17 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:36:17 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:36:17 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:36:17 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:36:17 [INFO] __main__: Starting game loop …
20:36:17 [INFO] __main__:   game loop running (1 s tick)
20:36:17 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:36:18 [INFO] websockets.server: connection open
20:36:18 [INFO] gameserver.network.server: Session registered: uid=-1
20:36:18 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 57669)
20:36:18 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:36:18 [INFO] gameserver.network.server: Session registered: uid=2
20:36:18 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:36:22 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:36:22 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:36:22 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:36:22 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:36:22 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:36:24 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:36:26 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:36:28 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:36:30 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:36:32 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:36:37 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4)
20:36:39 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:36:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:36:42 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
20:36:48 [INFO] __main__: Shutdown signal received — stopping …
20:36:48 [INFO] __main__: Shutting down …
20:36:48 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:36:48 [INFO] websockets.server: server closing
20:36:48 [INFO] gameserver.network.server: Session removed: uid=2
20:36:48 [INFO] websockets.server: server closed
20:36:48 [INFO] gameserver.network.server: WebSocket server stopped
20:36:48 [INFO] __main__:   WebSocket server stopped
20:36:48 [INFO] __main__:   debug dashboard stopped
20:36:48 [INFO] __main__:   database closed
20:36:48 [INFO] __main__:   goodbye
20:36:50 [INFO] __main__: === Game Server starting ===
20:36:50 [INFO] __main__: Loading configuration …
20:36:51 [INFO] __main__:   items:        210 loaded from config
20:36:51 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:36:51 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:36:51 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:36:51 [INFO] __main__:   game_config:  loaded
20:36:51 [INFO] __main__: Initializing persistence …
20:36:51 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:36:51 [INFO] __main__:   database:     connected (gameserver.db)
20:36:51 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:36:51 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:36:51 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:36:51 [INFO] __main__: Creating services …
20:36:51 [INFO] __main__:   upgrade_provider: 210 items registered
20:36:51 [INFO] __main__:   all services created
20:36:51 [INFO] __main__: Wiring event handlers …
20:36:51 [INFO] __main__:   event handlers registered
20:36:51 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:36:51 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:36:51 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:36:51 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:36:51 [INFO] __main__: Restored 2 empires from saved state
20:36:51 [INFO] __main__: Restored 1 attacks from saved state
20:36:51 [INFO] __main__: Starting network server …
20:36:51 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:36:51 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:36:51 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:36:51 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:36:51 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:36:51 [INFO] __main__: Starting game loop …
20:36:51 [INFO] __main__:   game loop running (1 s tick)
20:36:51 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:36:51 [INFO] websockets.server: connection open
20:36:51 [INFO] gameserver.network.server: Session registered: uid=-1
20:36:51 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 57681)
20:36:51 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:36:51 [INFO] gameserver.network.server: Session registered: uid=2
20:36:51 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:37:21 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:37:21 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:37:21 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:37:21 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:37:21 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:37:23 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:37:25 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:37:27 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:37:29 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:37:31 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:37:35 [INFO] __main__: Shutdown signal received — stopping …
20:37:35 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4)
20:37:36 [INFO] __main__: Shutting down …
20:37:36 [INFO] gameserver.persistence.state_save: Game state saved to state.yaml (2 empires, 1 attacks, 0 battles)
20:37:36 [INFO] websockets.server: server closing
20:37:36 [INFO] gameserver.network.server: Session removed: uid=2
20:37:36 [INFO] websockets.server: server closed
20:37:36 [INFO] gameserver.network.server: WebSocket server stopped
20:37:36 [INFO] __main__:   WebSocket server stopped
20:37:36 [INFO] __main__:   debug dashboard stopped
20:37:36 [INFO] __main__:   database closed
20:37:36 [INFO] __main__:   goodbye
20:37:37 [INFO] __main__: === Game Server starting ===
20:37:37 [INFO] __main__: Loading configuration …
20:37:38 [INFO] __main__:   items:        210 loaded from config
20:37:38 [INFO] __main__:   map:          4 paths, 23 build tiles from config/maps/default.yaml
20:37:38 [INFO] __main__:   ai_templates: 2 entries from config/ai_templates.yaml
20:37:38 [INFO] gameserver.loaders.game_config_loader: Loaded game config from config/game.yaml (30 keys)
20:37:38 [INFO] __main__:   game_config:  loaded
20:37:38 [INFO] __main__: Initializing persistence …
20:37:38 [INFO] gameserver.persistence.database: Database connected: gameserver.db
20:37:38 [INFO] __main__:   database:     connected (gameserver.db)
20:37:38 [INFO] gameserver.persistence.state_load: Restoring state from state2.yaml (saved at 2026-02-11T04:57:57, version 1)
20:37:38 [INFO] gameserver.persistence.state_load: Restored 2 empires, 1 attacks, 0 battles
20:37:38 [INFO] __main__:   state:        restored from disk (2 empires, 1 attacks)
20:37:38 [INFO] __main__: Creating services …
20:37:38 [INFO] __main__:   upgrade_provider: 210 items registered
20:37:38 [INFO] __main__:   all services created
20:37:38 [INFO] __main__: Wiring event handlers …
20:37:38 [INFO] __main__:   event handlers registered
20:37:38 [INFO] gameserver.engine.empire_service: Empire registered: uid=100 name='TestImperium'
20:37:38 [INFO] gameserver.engine.empire_service: Empire 100: recalculated effects → {}
20:37:38 [INFO] gameserver.engine.empire_service: Empire registered: uid=2 name='Empire1'
20:37:38 [INFO] gameserver.engine.empire_service: Empire 2: recalculated effects → {'life_offset': 0.001, 'gold_offset': 0.2, 'culture_offset': 0.2, 'culture_modifier': 0.1, 'gold_modifier': 0.1, 'build_speed_modifier': 0.1}
20:37:38 [INFO] __main__: Restored 2 empires from saved state
20:37:38 [INFO] __main__: Restored 1 attacks from saved state
20:37:38 [INFO] __main__: Starting network server …
20:37:38 [INFO] gameserver.network.handlers: Registered 31 message handlers: summary_request, item_request, military_request, map_load_request, map_save_request, new_item, new_structure, delete_structure, upgrade_structure, citizen_upgrade, change_citizen, increase_life, new_army, new_attack_request, change_army, new_wave, change_wave, end_siege, battle_register, battle_unregister, battle_next_wave_request, notification_request, user_message, timeline_request, userinfo_request, hall_of_fame_request, preferences_request, change_preferences, auth_request, signup, create_empire
20:37:38 [INFO] websockets.server: server listening on 0.0.0.0:8765
20:37:38 [INFO] gameserver.network.server: WebSocket server listening on ws://0.0.0.0:8765
20:37:38 [INFO] __main__:   WebSocket server listening on 0.0.0.0:8765
20:37:38 [INFO] gameserver.debug.dashboard: Debug dashboard running at http://0.0.0.0:9000/
20:37:38 [INFO] __main__: Starting game loop …
20:37:38 [INFO] __main__:   game loop running (1 s tick)
20:37:38 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: TRAVELLING → IN_SIEGE (attacker=100, defender=2, army=1)
20:37:39 [INFO] websockets.server: connection open
20:37:39 [INFO] gameserver.network.server: Session registered: uid=-1
20:37:39 [INFO] gameserver.network.server: Client connected: uid=-1 remote=('192.168.178.2', 57697)
20:37:39 [INFO] gameserver.engine.attack_service: [STATE] Attack 1: IN_SIEGE → IN_BATTLE (attacker=100, defender=2, army=1)
20:37:39 [INFO] gameserver.network.handlers: [battle:start_requested] attack_id=1 attacker=100 defender=2 army=1
20:37:39 [INFO] gameserver.network.handlers: [battle:start_requested] SUCCESS: battle 1 created (attacker=100, defender=2)
20:37:39 [INFO] gameserver.engine.battle_service: [battle_loop] Starting battle (bid=1, defender=2, attackers=[100])
20:37:39 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=1 (SWORDMAN) spawned from wave 1 (progress=1/6)
20:37:39 [INFO] gameserver.network.auth: Login success: eem (uid=2)
20:37:39 [INFO] gameserver.network.server: Session registered: uid=2
20:37:39 [INFO] gameserver.network.server: Session upgraded: guest=-1 → uid=2
20:37:41 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=2 (SWORDMAN) spawned from wave 1 (progress=2/6)
20:37:43 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=3 (SWORDMAN) spawned from wave 1 (progress=3/6)
20:37:45 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=4 (SWORDMAN) spawned from wave 1 (progress=4/6)
20:37:47 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=5 (SWORDMAN) spawned from wave 1 (progress=5/6)
20:37:49 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=6 (SWORDMAN) spawned from wave 1 (progress=6/6)
20:37:53 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=7 (SLAVE) spawned from wave 2 (progress=1/4)
20:37:55 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=8 (SLAVE) spawned from wave 2 (progress=2/4)
20:37:57 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=9 (SLAVE) spawned from wave 2 (progress=3/4)
20:37:59 [INFO] gameserver.engine.battle_service: [SPAWN] Critter cid=10 (SLAVE) spawned from wave 2 (progress=4/4)
